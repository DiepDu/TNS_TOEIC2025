@page "/Study/Study"
@model TNS_EDU_STUDY.Areas.Study.Pages.StudyModel
@{
    ViewData["Title"] = $"Luyện tập TOEIC Part {Model.SelectedPart}";
    Layout = "";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />


    <link rel="stylesheet" href="/css/Test.css" />


</head>
<body>
    @* Cấu trúc Header, Main Content, Sidebar Right gần như giữ nguyên từ Test.cshtml *@
    <div class="header">
        <button class="hamburger-btn" onclick="toggleSidebar()">☰</button>
        <button class="exit-btn" onclick="exitTest()">Exit</button>
        <div class="timer" id="timer">Time: 00:00</div>
        <button class="submit-btn" onclick="submitStudy()">Submit</button>
    </div>

    <div class="sidebar-left">
        @* Yêu cầu 2: Chỉ hiển thị một nút cho Part đang làm *@
        <button class="part-btn active" data-part="@Model.SelectedPart">
            <div class="part-btn-icon">
                @* Dùng if-else để hiển thị icon tương ứng *@
                @if (Model.SelectedPart == 1)
                {
                    <i class="fas fa-camera"></i>
                    ;
                }
                else if (Model.SelectedPart == 2)
                {

                    <i class="fas fa-question-circle"></i>
                    ;
                }
                else if (Model.SelectedPart == 3)
                {

                    <i class="fas fa-comments"></i>
                    ;
                }
                else if (Model.SelectedPart == 4)
                {

                    <i class="fas fa-bullhorn"></i>
                    ;
                }
                else if (Model.SelectedPart == 5)
                {

                    <i class="fas fa-edit"></i>
                    ;
                }
                else if (Model.SelectedPart == 6)
                {

                    <i class="fas fa-file-alt"></i>
                    ;
                }
                else if (Model.SelectedPart == 7)
                {

                    <i class="fas fa-newspaper"></i>
                    ;
                }
            </div>
            Part @Model.SelectedPart
        </button>
    </div>

    <div class="main-content">
        <div class="main-content-wrapper" id="main-content-wrapper">
        </div>
    </div>

    <div class="sidebar-right">
        <div id="answered-count" class="answered-count"></div>
        <h3>Questions</h3>
        <div class="part-section" id="question-list"></div>
    </div>

    @* Modal xác nhận, giữ nguyên *@
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="modal-content">
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-message">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm-btn" id="modal-confirm">Confirm</button>
                <button class="modal-btn cancel-btn" id="modal-cancel">Cancel</button>
            </div>
        </div>
    </div>
    <div id="confirm-submit-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Submit Study Session</h2>
            <p class="modal-text">Are you sure you want to finish and submit this study session?</p>
            <div class="modal-buttons">
                <button id="cancel-submit-btn" class="modal-btn cancel-btn">Cancel</button>
                <button id="confirm-submit-btn" class="modal-btn confirm-btn">Confirm</button>
            </div>
        </div>
    </div>
    <script>
        /*
        =================================================================================
        1. KHAI BÁO BIẾN TOÀN CỤC VÀ HẰNG SỐ
        =================================================================================
        */
        let timerInterval;
        let updateTimeInterval;

        // Lấy dữ liệu trực tiếp từ Razor Model (không dùng chuỗi)
        const questions = @Html.Raw(Model.QuestionsJson);
        const resultKey = '@Model.ResultKey';
        const testKey = '@Model.TestKey';
        const currentPart = @Model.SelectedPart;
        let timeRemaining = @Model.TimeRemaining.TotalSeconds;
        const resourceBaseUrl = 'https://localhost:7078';

        let flaggedQuestions = new Set();
        let questionStates = {};
        let debounceTimers = {};
        let sidebarState = 0;

        /*
        =================================================================================
        2. ĐỊNH NGHĨA TẤT CẢ CÁC HÀM
        =================================================================================
        */

        // Xử lý beforeunload để hiển thị hộp thoại xác nhận
        const handleBeforeUnload = (event) => {
            event.preventDefault();
            event.returnValue = '';
        };

                    // Dán hàm này vào vị trí của hàm debounce cũ
        function debouncedSaveAnswer(questionKey, answerKey, timeSpent, part) {
            // Nếu đã có một lần hẹn giờ cho câu hỏi này, hãy hủy nó đi
            if (debounceTimers[questionKey]) {
                clearTimeout(debounceTimers[questionKey]);
            }

            // Tạo một lần hẹn giờ mới CHỈ cho câu hỏi này
            debounceTimers[questionKey] = setTimeout(() => {
                saveAnswer(questionKey, answerKey, timeSpent, part);
            }, 1000); // Vẫn delay 1 giây
        }
     
        function initializeQuestionState(questionKey, part) {
            if (!questionStates[questionKey]) {
                questionStates[questionKey] = {
                    isVisible: false,
                    startTime: null,
                    lastVisibleTime: null, // <-- Đổi tên từ lastAnswerTime
                    timeSpent: 0,
                    answerChanges: 0,
                    part: part
                };
            }
        }


                 // Áp dụng cho cả Study.cshtml và Test.cshtml
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const questionKey = entry.target.getAttribute('data-question-key');
                    if (!questionKey || !questionStates[questionKey]) return;

                    const state = questionStates[questionKey];

                    if (entry.isIntersecting) {
                        // KHI CÂU HỎI HIỆN RA: chỉ ghi lại thời điểm nó bắt đầu được nhìn thấy.
                        state.lastVisibleTime = Date.now();
                    } else {
                        // KHI CÂU HỎI BIẾN MẤT: tính toán thời gian đã nhìn thấy và cộng dồn.
                        if (state.lastVisibleTime) {
                            const timeDiff = (Date.now() - state.lastVisibleTime) / 1000;
                            state.timeSpent += timeDiff;
                            state.lastVisibleTime = null; // Reset lại để lần sau tính tiếp
                        }
                    }
                });
            }, { threshold: 0.5 });

            document.querySelectorAll('.question-container, .sub-question').forEach(element => {
                const questionKey = element.getAttribute('data-question-key');
                if (questionKey) observer.observe(element);
            });
        }

        // ======= Giao tiếp server: lưu đáp án, flagged, update time =======
          async function saveAnswer(questionKey, answerKey, timeSpent, part) {
            try {
                const response = await fetch('/Study/Study?handler=SaveAnswer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resultKey: resultKey,
                        questionKey: questionKey,
                        selectAnswerKey: answerKey,
                        timeSpent: timeSpent,
                        part: part
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    console.error('Error saving answer for question ' + questionKey + ':', data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error saving answer for question ' + questionKey + ':', error);
            }
        }
       

        async function loadFlaggedQuestions() {
            try {
                      // THAY ĐỔI DÒNG NÀY
        const response = await fetch(`/Study/Study?handler=FlaggedQuestions&resultKey=${resultKey}`);
                const data = await response.json();
                if (response.ok && Array.isArray(data)) {
                    flaggedQuestions = new Set(data);
                    updateQuestionList();
                } else {
                    console.error('Error loading flagged questions:', data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error loading flagged questions:', error);
            }
        }

        async function saveFlaggedQuestion(questionKey, isFlagged) {
            try {
                       // THAY ĐỔI DÒNG NÀY
        const response = await fetch('/Study/Study?handler=SaveFlaggedQuestion', {
       
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resultKey: resultKey,
                        questionKey: questionKey,
                        isFlagged: isFlagged
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    console.error('Error saving flagged question:', data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error saving flagged question:', error);
            }
        }

        // Toggle flagged
        async function toggleFlag(questionKey) {
            const flagElement = document.querySelector(`.flag-icon[data-question-key="${questionKey}"]`);
            const isFlagged = flaggedQuestions.has(questionKey);

            if (isFlagged) {
                flaggedQuestions.delete(questionKey);
                if (flagElement) flagElement.classList.remove('flagged');
                await saveFlaggedQuestion(questionKey, false);
            } else {
                flaggedQuestions.add(questionKey);
                if (flagElement) flagElement.classList.add('flagged');
                await saveFlaggedQuestion(questionKey, true);
            }
            updateQuestionList();
        }

        // ======= Cập nhật UI danh sách câu hỏi (sidebar) =======
        function updateQuestionList() {
            const listContainer = document.getElementById('question-list');
            const answeredContainer = document.getElementById('answered-count');
            if (!listContainer || !answeredContainer) return;

            let html = '';
            let displayedQuestions = [];

            if (currentPart <= 2 || currentPart === 5) {
                displayedQuestions = questions.filter(q => q.parent === null);
            } else {
                const parentQuestions = questions.filter(q => q.parent === null);
                displayedQuestions = parentQuestions.flatMap(p => p.children || []);
            }

            const answeredCount = displayedQuestions.filter(q => q.userAnswerKey && q.userAnswerKey !== '').length;
            const totalCount = displayedQuestions.length;
            answeredContainer.innerHTML = `Answered: ${answeredCount}/${totalCount}`;

            displayedQuestions.forEach(q => {
                const isSelected = q.userAnswerKey && q.userAnswerKey !== '';
                const isFlagged = flaggedQuestions.has(q.questionKey);
                html += `<a href="#" class="question-circle ${isSelected ? 'selected' : ''} ${isFlagged ? 'flagged' : ''}" data-key="${q.questionKey}" onclick="scrollToQuestion('${q.questionKey}')">${q.order}</a>`;
            });

            listContainer.innerHTML = html;
        }

        // ======= Chọn/Bỏ chọn đáp án =======
        function updateAnswer(questionKey, answerKey) {
            let question = questions.find(q => q.questionKey === questionKey);
            if (!question) {
                for (const parent of questions) {
                    if (parent.children) {
                        question = parent.children.find(child => child.questionKey === questionKey);
                        if (question) break;
                    }
                }
            }

            if (question) {
                question.userAnswerKey = answerKey; // có thể là null
                const answerOptions = document.querySelectorAll(`.answer-option input[name="answer_${questionKey}"]`);
                answerOptions.forEach(option => {
                    const parent = option.parentElement;
                    if (answerKey === null) {
                        option.checked = false;
                        parent.classList.remove('selected');
                    } else if (option.value === answerKey) {
                        parent.classList.add('selected');
                    } else {
                        parent.classList.remove('selected');
                    }
                });
                updateQuestionList();
                updateProgressCircle();
            } else {
                console.error(`Question with key ${questionKey} not found.`);
            }
        }

        function selectAnswer(questionKey, answerKey) {
            let question = questions.find(q => q.questionKey === questionKey);
            if (!question) {
                for (const parent of questions) {
                    if (parent.children) {
                        question = parent.children.find(child => child.questionKey === questionKey);
                        if (question) break;
                    }
                }
            }
            if (!question) return;

            const radioButton = document.querySelector(`input[name="answer_${questionKey}"][value="${answerKey}"]`);
            if (!radioButton) return;

            const isAlreadySelected = question.userAnswerKey === answerKey;
            const state = questionStates[questionKey];
            const currentTime = Date.now();

            // **LOGIC TÍNH TOÁN MỚI**
            // 1. Tính toán và cộng nốt phần thời gian từ lúc câu hỏi hiện ra cho tới lúc click.
            if (state.lastVisibleTime) {
                const timeDiff = (currentTime - state.lastVisibleTime) / 1000;
                state.timeSpent += timeDiff;
            }

            // 2. Cập nhật lại thời điểm cuối cùng, chuẩn bị cho lần tính toán tiếp theo.
            state.lastVisibleTime = currentTime;
            state.answerChanges += 1;

            // Phần logic còn lại giữ nguyên
            if (isAlreadySelected) { // Bỏ chọn
                radioButton.checked = false;
                updateAnswer(questionKey, null);
                debouncedSaveAnswer(questionKey, null, Math.round(state.timeSpent), state.part);
            } else { // Chọn mới
                radioButton.checked = true;
                updateAnswer(questionKey, answerKey);
                debouncedSaveAnswer(questionKey, answerKey, Math.round(state.timeSpent), state.part);
            }
        }
        // ======= Render ==========================
        function renderSimplePart(container) {
            const partQuestions = questions.filter(q => Number(q.part) === currentPart && q.parent === null);
            let html = '';
            partQuestions.forEach(question => {
                initializeQuestionState(question.questionKey, question.part);
                const isFlagged = flaggedQuestions.has(question.questionKey);
                html += `
                    <div class="question-container" id="question-${question.questionKey}" data-question-key="${question.questionKey}">
                        <h2>Question ${question.order}</h2>
                        <span class="flag-icon ${isFlagged ? 'flagged' : ''}" data-question-key="${question.questionKey}"><i class="fas fa-flag"></i></span>
                        ${question.questionImage ? `<img src="${resourceBaseUrl}${question.questionImage}" alt="Question Image" class="question-image" loading="lazy">` : ''}
                        ${question.questionVoice ? `
                            <audio controls class="question-audio">
                                <source src="${resourceBaseUrl}${question.questionVoice}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>` : ''}
                        ${question.questionText ? `<div class="question-text">${question.questionText}</div>` : ''}
                        <div class="answer-options">
                `;
                question.answers.forEach((answer, idx) => {
                    const label = (currentPart === 1 || currentPart === 2)
                        ? (answer.ranking === 1 ? 'A' : answer.ranking === 2 ? 'B' : answer.ranking === 3 ? 'C' : answer.ranking === 4 ? 'D' : '?')
                        : String.fromCharCode(65 + idx);
                    const isChecked = answer.answerKey === question.userAnswerKey ? 'checked' : '';
                    const isSelected = answer.answerKey === question.userAnswerKey ? 'selected' : '';
                    html += `
                        <div class="answer-option ${isSelected}" onclick="selectAnswer('${question.questionKey}', '${answer.answerKey}')">
                            <input type="radio" name="answer_${question.questionKey}" id="answer_${answer.answerKey}"
                                   value="${answer.answerKey}" ${isChecked}>
                            <label for="answer_${answer.answerKey}">
                                <span class="label-text">${label}</span>
                                ${currentPart === 1 || currentPart === 2 ? '' : `<span class="colon">:</span> <span class="answer-content">${answer.answerText}</span>`}
                            </label>
                        </div>
                    `;
                });
                html += '</div></div>';
            });
            container.innerHTML = html;

           

            document.querySelectorAll('.flag-icon').forEach(flag => {
                flag.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const questionKey = flag.getAttribute('data-question-key');
                    toggleFlag(questionKey);
                });
            });

            setupIntersectionObserver();
        }

        function renderComplexPart(container) {
            const parentQuestions = questions.filter(q => Number(q.part) === currentPart && q.parent === null);
            let html = '';

            if (parentQuestions.length === 0) {
                container.innerHTML = `<p>No questions available for Part ${currentPart}.</p>`;
                return;
            }

            parentQuestions.forEach(parent => {
                html += `
                    <div class="part3-container">
                        <div class="part3-left">
                            <h2>Part ${currentPart}: Conversation</h2>
                            ${parent.questionImage ? `<img src="${resourceBaseUrl}${parent.questionImage}" alt="Part ${currentPart} Image" class="question-image" loading="lazy">` : ''}
                            ${parent.questionVoice ? `
                                <audio controls class="question-audio">
                                    <source src="${resourceBaseUrl}${parent.questionVoice}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>` : ''}
                            ${parent.questionText ? `<div class="question-text">${parent.questionText}</div>` : ''}
                        </div>
                        <div class="part3-right">
                `;
                const children = parent.children || [];
                children.forEach(child => {
                    initializeQuestionState(child.questionKey, child.part);
                    const isFlagged = flaggedQuestions.has(child.questionKey);
                    html += `
                        <div class="sub-question" id="question-${child.questionKey}" data-question-key="${child.questionKey}">
                            <h4>Question ${child.order}${child.questionText ? `<span class="question-content">: ${child.questionText}</span>` : ''}</h4>
                            <span class="flag-icon ${isFlagged ? 'flagged' : ''}" data-question-key="${child.questionKey}"><i class="fas fa-flag"></i></span>
                            ${child.questionImage ? `<img src="${resourceBaseUrl}${child.questionImage}" alt="Sub Question Image" class="sub-question-image" loading="lazy">` : ''}
                            ${child.questionVoice ? `
                                <audio controls class="sub-question-audio">
                                    <source src="${resourceBaseUrl}${child.questionVoice}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>` : ''}
                            <div class="answer-options">
                    `;
                    child.answers.forEach((answer, idx) => {
                        const label = String.fromCharCode(65 + idx);
                        const isChecked = answer.answerKey === child.userAnswerKey ? 'checked' : '';
                        const isSelected = answer.answerKey === child.userAnswerKey ? 'selected' : '';
                        html += `
                            <div class="answer-option ${isSelected}" onclick="selectAnswer('${child.questionKey}', '${answer.answerKey}')">
                                <input type="radio" name="answer_${child.questionKey}" id="answer_${answer.answerKey}"
                                       value="${answer.answerKey}" ${isChecked}>
                                <label for="answer_${answer.answerKey}">
                                    <span class="label-text">${label}</span>
                                    <span class="colon">:</span>
                                    <span class="answer-content">${answer.answerText}</span>
                                </label>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                });
                html += '</div></div>';
            });

            container.innerHTML = html;

          

            document.querySelectorAll('.flag-icon').forEach(flag => {
                flag.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const questionKey = flag.getAttribute('data-question-key');
                    toggleFlag(questionKey);
                });
            });

            setupIntersectionObserver();
        }

        // Scroll tới câu hỏi
        function scrollToQuestion(questionKey) {
            const element = document.getElementById(`question-${questionKey}`);
            if (element) element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Modal xác nhận (dùng chung)
        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            if (!modal) {
                // fallback: confirm browser
                if (confirm(message)) {
                    if (onConfirm) onConfirm();
                }
                return;
            }

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.add('active');

            confirmBtn.onclick = () => {
                modal.classList.remove('active');
                if (onConfirm) onConfirm();
            };

            cancelBtn.onclick = () => {
                modal.classList.remove('active');
            };
        }

        // Exit test (quay về trang Study)
        function exitTest() {
            showConfirmationModal(
                'Exit Study Session',
                'Are you sure you want to exit? Your progress will be saved.',
                () => {
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    window.location.href = '/Study';
                }
            );
        }

        // ======= Submit study (tự động hoặc thủ công) =======
        async function submitStudy() {
            const confirmModal = document.getElementById('confirm-submit-modal');
            const confirmBtn = document.getElementById('confirm-submit-btn');
            const cancelBtn = document.getElementById('cancel-submit-btn');

            // nếu không có modal, fallback dùng confirm
            if (!confirmModal) {
                if (!confirm('Submit study session?')) return;
            } else {
                confirmModal.style.display = 'block';
                const userConfirmed = await new Promise(resolve => {
                    confirmBtn.onclick = () => { confirmModal.style.display = 'none'; resolve(true); };
                    cancelBtn.onclick = () => { confirmModal.style.display = 'none'; resolve(false); };
                });
                if (!userConfirmed) return;
            }

            // Dừng timer & update interval
            clearInterval(timerInterval);
            clearInterval(updateTimeInterval);

            try {
                const response = await fetch('/Study/Study?handler=SubmitStudy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resultKey: resultKey,
                        selectedPart: currentPart
                    })
                });

                if (response.ok) {
                    window.location.href = `/Study/ResultStudy?TestKey=${testKey}&ResultKey=${resultKey}&PartSelect=${currentPart}`;
                } else {
                    console.error('Failed to submit study session.');
                    alert('An error occurred while submitting. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting study session:', error);
                alert('An error occurred. Please check your connection and try again.');
            }
        }

        // ======= Timer: đếm ngược + cập nhật lên server mỗi phút (đã hợp nhất) =======
        function startTimer() {
            const timerElement = document.getElementById('timer');
            if (!timerElement) return;

            // Đồng hồ đếm ngược mỗi giây
            timerInterval = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = Math.round(timeRemaining % 60);
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    clearInterval(timerInterval);
                    timerElement.textContent = "00:00";
                    // tự động nộp
                    submitStudy();
                }
            }, 1000);

            // Cập nhật thời gian đã làm lên server mỗi 60 giây
            updateTimeInterval = setInterval(() => {
                try {
                    fetch('/Study/Study?handler=UpdateTimeSpent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resultKey: resultKey })
                    });
                } catch (error) {
                    console.error('Failed to update time spent:', error);
                }
            }, 60000);
        }

        // ======= Sidebar helper / progress ==========
        function getTotalQuestions() {
            let total = 0;
            questions.forEach(q => {
                if (q.parent === null) {
                    if (q.children && q.children.length > 0) {
                        total += q.children.length;
                    } else {
                        total += 1;
                    }
                }
            });
            return total;
        }

        function getAnsweredQuestions() {
            let answered = 0;
            questions.forEach(q => {
                if (q.parent === null && q.children && q.children.length > 0) {
                    answered += q.children.filter(child => child.userAnswerKey && child.userAnswerKey !== '').length;
                } else if (q.parent === null && q.userAnswerKey && q.userAnswerKey !== '') {
                    answered += 1;
                }
            });
            return answered;
        }

        function updateProgressCircle() {
            const totalQuestions = getTotalQuestions();
            const answeredQuestions = getAnsweredQuestions();
            const text = document.getElementById('progress-text');
            if (text) text.textContent = `${answeredQuestions}/${totalQuestions}`;
        }

        // Reload if page was loaded from BFCache
        window.onpageshow = function (event) {
            if (event.persisted) {
                window.location.reload();
            }
        };

        // Keydown navigation (ArrowUp/ArrowDown)
        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                const questionsOnPage = Array.from(document.querySelectorAll('.question-container, .sub-question'));
                if (questionsOnPage.length < 2) return;

                const viewportCenter = window.innerHeight / 2;
                let currentQuestionOnPage = null;
                let minDistanceToCenter = Infinity;

                questionsOnPage.forEach(q => {
                    const rect = q.getBoundingClientRect();
                    const questionCenter = rect.top + (rect.height / 2);
                    const distance = Math.abs(questionCenter - viewportCenter);
                    if (distance < minDistanceToCenter) {
                        minDistanceToCenter = distance;
                        currentQuestionOnPage = q;
                    }
                });

                if (!currentQuestionOnPage) return;
                const currentIndex = questionsOnPage.indexOf(currentQuestionOnPage);
                if (currentIndex === -1) return;

                let nextIndex = currentIndex;
                if (event.key === 'ArrowUp' && currentIndex > 0) {
                    nextIndex--;
                } else if (event.key === 'ArrowDown' && currentIndex < questionsOnPage.length - 1) {
                    nextIndex++;
                }

                const nextQuestionOnPage = questionsOnPage[nextIndex];
                if (nextQuestionOnPage && nextQuestionOnPage !== currentQuestionOnPage) {
                    nextQuestionOnPage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    const nextKey = nextQuestionOnPage.getAttribute('data-question-key');
                    if (nextKey) {
                        const questionCircles = Array.from(document.querySelectorAll('.question-circle'));
                        questionCircles.forEach(circle => {
                            if (circle.getAttribute('data-key') === nextKey) {
                                circle.classList.add('active');
                            } else {
                                circle.classList.remove('active');
                            }
                        });
                    }
                }
            }
        });

        /*
        =================================================================================
        3. ĐIỂM KHỞI CHẠY (ENTRY POINT)
        =================================================================================
        */
        /* =================================================================================
            4. LOGIC SIDEBAR MOBILE (HAMBURGER BUTTON)
            =================================================================================
         */
         function toggleSidebar() {
             const leftSidebar = document.querySelector('.sidebar-left');
             const rightSidebar = document.querySelector('.sidebar-right');

             // Chuyển đổi trạng thái: 0 (Ẩn hết) -> 1 (Hiện Trái) -> 2 (Hiện Phải) -> 0 (Ẩn hết)
             sidebarState = (sidebarState + 1) % 3;

             if (sidebarState === 1) {
                 // Trạng thái 1: Hiện Sidebar Trái (Danh sách Part)
                 leftSidebar.classList.add('active');
                 rightSidebar.classList.remove('active');
             } else if (sidebarState === 2) {
                 // Trạng thái 2: Hiện Sidebar Phải (Danh sách Câu hỏi)
                 leftSidebar.classList.remove('active');
                 rightSidebar.classList.add('active');
             } else {
                 // Trạng thái 0: Ẩn cả hai để hiện nội dung chính
                 leftSidebar.classList.remove('active');
                 rightSidebar.classList.remove('active');
             }
         }

         // Tinh chỉnh UX: Khi click vào một câu hỏi trên Sidebar Mobile, tự động đóng Sidebar để xem nội dung
         const originalScrollToQuestion = scrollToQuestion; // Lưu lại hàm cũ
         scrollToQuestion = function(questionKey) {
             // Gọi hàm gốc để scroll
             originalScrollToQuestion(questionKey);

             // Nếu đang ở mobile, đóng sidebar sau khi chọn
             if (window.innerWidth <= 768) {
                 const rightSidebar = document.querySelector('.sidebar-right');
                 const leftSidebar = document.querySelector('.sidebar-left');

                 rightSidebar.classList.remove('active');
                 leftSidebar.classList.remove('active');
                 sidebarState = 0; // Reset về trạng thái đóng
             }
         };
        window.onload = async function () {
            // Đăng ký beforeunload
            window.addEventListener('beforeunload', handleBeforeUnload);

            // Tải flagged questions từ server (nếu có)
            await loadFlaggedQuestions();

            // Render nội dung
            const container = document.getElementById('main-content-wrapper');
            if (container) {
                if ([1, 2, 5].includes(currentPart)) {
                    renderSimplePart(container);
                } else {
                    renderComplexPart(container);
                }
            }

            // Cập nhật danh sách sidebar
            updateQuestionList();

            // Khởi tạo state cho từng câu hỏi
            questions.forEach(q => {
                initializeQuestionState(q.questionKey, q.part);
                if (q.children) q.children.forEach(child => initializeQuestionState(child.questionKey, child.part));
            });

            // Gắn sự kiện click cho question-list (delegation)
            const qlist = document.getElementById('question-list');
            if (qlist) {
                qlist.addEventListener('click', function(event) {
                    if (event.target.classList.contains('question-circle')) {
                        event.preventDefault();
                        const questionKey = event.target.getAttribute('data-key');
                        if (questionKey) scrollToQuestion(questionKey);
                    }
                });
            }

            // Bắt đầu timer sau khi mọi thứ sẵn sàng
            startTimer();
        };
    </script>

</body>
</html>
<style>
    /* ============================================
       BASE STYLES & RESET
       ============================================ */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html, body {
        height: 100vh;
        margin: 0;
        overflow: hidden;
    }

    body {
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #E8F4F8 0%, #FFF9E6 50%, #F0E6F6 100%);
        display: flex;
        position: relative;
        color: #2C3E50;
        line-height: 1.5;
    }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/stardust.png');
            opacity: 0.05;
            z-index: 0;
            pointer-events: none;
        }

    /* ============================================
       HEADER SECTION - Giảm chiều cao
       ============================================ */
    .header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(90deg, #6B9BC3 0%, #4A7BA7 50%, #2E5C8A 100%);
        padding: 8px 20px; /* Giảm từ 12px 24px */
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 3px 12px rgba(46, 92, 138, 0.2);
        z-index: 10;
        animation: slideInDown 0.6s ease-out;
        border-bottom: 2px solid #87A878; /* Giảm từ 3px */
        height: 50px; /* Chiều cao cố định */
    }

    .hamburger-btn {
        display: none;
        font-size: 1.3rem;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        cursor: pointer;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

        .hamburger-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

    @@media (max-width: 768px) {
        .hamburger-btn

    {
        display: block;
    }

    }

    .exit-btn, .submit-btn {
        padding: 8px 18px; /* Giảm từ 10px 24px */
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem; /* Giảm từ 0.875rem */
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .exit-btn {
        background: white;
        color: #E8956F;
        border: 2px solid #E8956F;
    }

        .exit-btn:hover {
            background: #E8956F;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(232, 149, 111, 0.3);
        }

    .submit-btn {
        background: linear-gradient(135deg, #87A878 0%, #A8D8B9 100%);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

        .submit-btn:hover {
            background: linear-gradient(135deg, #6B8E5F 0%, #87A878 100%);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(135, 168, 120, 0.3);
        }

    .timer {
        font-size: 1.2rem; /* Giảm từ 1.5rem */
        font-weight: 700;
        color: white;
        background: rgba(255, 255, 255, 0.2);
        padding: 6px 18px; /* Giảm từ 8px 24px */
        border-radius: 8px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        font-variant-numeric: tabular-nums;
        letter-spacing: 0.8px;
        backdrop-filter: blur(10px);
    }

        .timer.warning {
            color: white;
            background: linear-gradient(135deg, #E8956F 0%, #D97AA6 100%);
            border-color: white;
            animation: timerPulse 1s infinite;
        }

    @@keyframes timerPulse {
        0%, 100%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.05);
    }

    }

    /* ============================================
       SIDEBAR LEFT - Thu nhỏ
       ============================================ */
    .sidebar-left {
        width: 130px; /* Giảm từ 150px */
        background: linear-gradient(180deg, #FFF9E6 0%, #E8F4F8 100%);
        padding: 16px 10px; /* Giảm từ 20px 12px */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: calc(100vh - 50px); /* Điều chỉnh theo header mới */
        position: fixed;
        left: 0;
        top: 50px;
        box-shadow: 3px 0 12px rgba(46, 92, 138, 0.1);
        z-index: 1;
        border-right: 2px solid #87A878;
    }

    .part-btn {
        background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
        color: #2E5C8A;
        padding: 14px 12px; /* Giảm từ 20px 16px */
        border: 2px solid #87A878; /* Giảm từ 3px */
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.95rem; /* Giảm từ 1.1rem */
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 3px 12px rgba(135, 168, 120, 0.18);
        width: 100%;
        height: 110px; /* Giảm từ 140px */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

        .part-btn:hover {
            background: linear-gradient(135deg, #A8D8B9 0%, #87A878 100%);
            color: white;
            border-color: #6B8E5F;
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 6px 18px rgba(135, 168, 120, 0.35);
        }

        .part-btn.active {
            background: linear-gradient(135deg, #87A878 0%, #A8D8B9 100%);
            color: white;
            border-color: #6B8E5F;
            box-shadow: 0 5px 16px rgba(135, 168, 120, 0.35), 0 0 0 3px rgba(135, 168, 120, 0.15);
            position: relative;
        }

            .part-btn.active::before {
                content: '📚';
                position: absolute;
                top: 6px;
                right: 6px;
                font-size: 1.2rem; /* Giảm từ 1.5rem */
                animation: float 2s ease-in-out infinite;
            }

    .part-btn-icon {
        font-size: 2rem; /* Giảm từ 2.5rem */
        margin-bottom: 4px;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.08));
    }

    .part-btn.active .part-btn-icon {
        animation: bounce 1s ease-in-out infinite;
    }

    @@keyframes float {
        0%, 100%

    {
        transform: translateY(0px);
    }

    50% {
        transform: translateY(-4px);
    }

    }

    @@keyframes bounce {
        0%, 100%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.08);
    }

    }

    /* ============================================
       SIDEBAR RIGHT - Thu nhỏ
       ============================================ */
    .sidebar-right {
        width: 160px; /* Giảm từ 180px */
        background: linear-gradient(180deg, #FFF9E6 0%, #E8F4F8 100%);
        padding: 16px; /* Giảm từ 20px */
        display: flex;
        flex-direction: column;
        align-items: center;
        height: calc(100vh - 50px);
        position: fixed;
        right: 0;
        top: 50px;
        box-shadow: -3px 0 12px rgba(46, 92, 138, 0.1);
        overflow-y: hidden;
        z-index: 1;
        border-left: 2px solid #87A878;
    }

        .sidebar-right h3 {
            background: linear-gradient(90deg, #2E5C8A 0%, #4A7BA7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1rem; /* Giảm từ 1.125rem */
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 700;
        }

    .answered-count {
        font-size: 0.9rem; /* Giảm từ 1rem */
        font-weight: 700;
        color: #2E5C8A;
        background: linear-gradient(135deg, #FFF4E0 0%, #E8F4F8 100%);
        margin-bottom: 12px;
        padding: 8px 16px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(46, 92, 138, 0.08);
        border: 2px solid #87A878;
        order: 1;
    }

    .part-section {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px; /* Giảm từ 12px */
        margin-bottom: 12px;
        overflow-y: auto;
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: #87A878 rgba(255, 249, 230, 0.5);
        padding-bottom: 60px;
        order: 2;
    }

        .part-section::-webkit-scrollbar {
            width: 5px;
        }

        .part-section::-webkit-scrollbar-track {
            background: rgba(255, 249, 230, 0.5);
            border-radius: 8px;
        }

        .part-section::-webkit-scrollbar-thumb {
            background: #87A878;
            border-radius: 8px;
        }

            .part-section::-webkit-scrollbar-thumb:hover {
                background: #6B8E5F;
            }

    /* ============================================
       QUESTION CIRCLES - Thu nhỏ
       ============================================ */
    .question-circle {
        width: 42px; /* Giảm từ 48px */
        height: 42px;
        background: white;
        color: #2E5C8A;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.9rem;
        text-decoration: none;
        border: 2px solid #87A878;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 2px 6px rgba(135, 168, 120, 0.15);
    }

        .question-circle:hover {
            background: linear-gradient(135deg, #A8D8B9 0%, #87A878 100%);
            color: white;
            border-color: #6B8E5F;
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(135, 168, 120, 0.35);
        }

        .question-circle.selected {
            background: linear-gradient(135deg, #87A878 0%, #A8D8B9 100%);
            color: white;
            border-color: #6B8E5F;
        }

        .question-circle.flagged {
            background: linear-gradient(135deg, #F4A259 0%, #D4AF37 100%);
            color: white;
            border-color: #D4AF37;
            animation: pulse 2s ease-in-out infinite;
        }

        .question-circle.active {
            background: linear-gradient(135deg, #2E5C8A 0%, #4A7BA7 100%);
            color: white;
            border-color: #2E5C8A;
            box-shadow: 0 0 0 3px rgba(46, 92, 138, 0.25);
        }

    @@keyframes pulse {
        0%, 100%

    {
        transform: scale(1);
        box-shadow: 0 2px 6px rgba(212, 175, 55, 0.15);
    }

    50% {
        transform: scale(1.05);
        box-shadow: 0 3px 10px rgba(212, 175, 55, 0.35);
    }

    }

    /* ============================================
       MAIN CONTENT AREA
       ============================================ */
    .main-content {
        margin-left: 130px; /* Điều chỉnh theo sidebar mới */
        margin-right: 160px;
        padding: 60px 24px 24px; /* Giảm padding */
        flex: 1;
        overflow-y: auto;
        min-height: calc(100vh - 50px);
        -webkit-overflow-scrolling: touch;
        position: relative;
    }

        .main-content::-webkit-scrollbar {
            width: 10px; /* Rộng hơn sidebar 1 chút để dễ kéo */
        }

        .main-content::-webkit-scrollbar-track {
            background: rgba(255, 249, 230, 0.5); /* Nền nhạt */
            border-radius: 10px;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #87A878 0%, #6B8E5F 100%); /* Gradient Xanh */
            border-radius: 10px;
            border: 2px solid transparent; /* Viền trong suốt tạo cảm giác nổi */
            background-clip: content-box;
        }

            .main-content::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #6B8E5F 0%, #557C4B 100%); /* Đậm hơn khi hover */
                border: 2px solid transparent;
                background-clip: content-box;
            }
    .main-content-wrapper {
        min-height: 100%;
        padding-bottom: 24px;
    }

    /* ============================================
       QUESTION CONTAINERS - Giảm padding và margin
       ============================================ */
    .question-container, .sub-question {
        position: relative;
    }

    .question-container {
        background: linear-gradient(to bottom, #FFFFFF, #F9FAFB);
        border-radius: 12px; /* Giảm từ 16px */
        padding: 20px; /* Giảm từ 32px */
        box-shadow: 0 3px 12px rgba(46, 92, 138, 0.1);
        max-width: 900px;
        margin: 0 auto 20px; /* Giảm margin-bottom từ 32px */
        animation: fadeInUp 0.5s ease-out;
        border: 2px solid #E8DED2;
        border-left: 4px solid #87A878;
    }

        .question-container:hover {
            border-left-width: 6px;
            box-shadow: 0 5px 16px rgba(135, 168, 120, 0.18);
            transform: translateY(-2px);
        }

        .question-container h2 {
            font-weight: 700;
            background: linear-gradient(90deg, #2E5C8A 0%, #4A7BA7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px; /* Giảm từ 24px */
            font-size: 1.3rem; /* Giảm từ 1.5rem */
            padding-bottom: 12px;
            border-bottom: 3px solid #87A878;
        }

    .part3-left h2 {
        font-weight: 700;
        background: linear-gradient(90deg, #2E5C8A 0%, #4A7BA7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 16px;
        font-size: 1.3rem;
    }

    /* ============================================
       FLAG ICON - Thu nhỏ
       ============================================ */
    .flag-icon {
        position: absolute;
        top: 4px; /* Giảm từ 24px */
        right: 4px;
        font-size: 1.5rem; /* Giảm từ 1.8rem */
        color: #8E9AAF;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 6px;
        border-radius: 50%;
    }

        .flag-icon:hover {
            color: #F4A259;
            background: rgba(244, 162, 89, 0.12);
            transform: scale(1.25) rotate(12deg);
        }

        .flag-icon.flagged {
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.15);
            animation: flagWave 0.5s ease-in-out;
        }

    @@keyframes flagWave {
        0%, 100%

    {
        transform: rotate(0deg);
    }

    25% {
        transform: rotate(-12deg);
    }

    75% {
        transform: rotate(12deg);
    }

    }

    /* ============================================
       QUESTION MEDIA - Giảm kích thước
       ============================================ */
    .question-image {
        width: 250px; /* Cố định chiều rộng */
        height: 250px; /* Cố định chiều cao = chiều rộng để tạo hình vuông */
        object-fit: cover; /* Cắt ảnh vừa khung vuông */
        border-radius: 10px;
        margin: 12px auto; /* Giảm margin */
        display: block;
        box-shadow: 0 3px 12px rgba(46, 92, 138, 0.1);
        transition: transform 0.3s ease;
        border: 2px solid #E8DED2;
    }

        .question-image:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 18px rgba(46, 92, 138, 0.14);
        }

    .question-audio {
        margin-bottom: 16px; /* Giảm từ 24px */
        width: 100%;
        max-width: 400px; /* Giảm từ 500px */
        border-radius: 8px;
        background: linear-gradient(135deg, #FFF4E0 0%, #E8F4F8 100%);
        padding: 10px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 2px 6px rgba(46, 92, 138, 0.08);
        border: 2px solid #E8DED2;
    }

        .question-audio:hover {
            transform: scale(1.01);
            box-shadow: 0 3px 10px rgba(46, 92, 138, 0.12);
        }

    .question-text {
        font-size: 1rem; /* Giảm từ 1.125rem */
        line-height: 1.6; /* Giảm từ 1.8 */
        color: #2C3E50;
        font-weight: 400;
        margin-bottom: 20px; /* Giảm từ 32px */
        text-align: left;
        padding: 16px; /* Giảm từ 24px */
        background: linear-gradient(135deg, #FFF4E0 0%, #E8F4F8 100%);
        border-radius: 10px;
        border-left: 4px solid #87A878;
        box-shadow: 0 2px 6px rgba(46, 92, 138, 0.06);
    }

    /* ============================================
       ANSWER OPTIONS - Giảm kích thước
       ============================================ */
    .answer-options {
        display: flex;
        flex-direction: column;
        gap: 12px; /* Giảm từ 16px */
    }

    .answer-option {
        display: flex;
        align-items: center;
        gap: 12px;
        background: white;
        padding: 12px 18px; /* Giảm từ 16px 24px */
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #E8DED2;
        box-shadow: 0 2px 6px rgba(46, 92, 138, 0.06);
    }

        .answer-option:hover {
            background: linear-gradient(135deg, #A8D8B9 0%, #87A878 100%);
            border-color: #6B8E5F;
            color: white;
            transform: translateX(4px);
            box-shadow: 0 3px 10px rgba(135, 168, 120, 0.25);
        }

            .answer-option:hover label,
            .answer-option:hover .label-text,
            .answer-option:hover .answer-content,
            .answer-option:hover .colon {
                color: white;
            }

        .answer-option.selected {
            background: linear-gradient(135deg, #87A878 0%, #A8D8B9 100%);
            border-color: #6B8E5F;
            color: white;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(135, 168, 120, 0.25);
        }

            .answer-option.selected label,
            .answer-option.selected .label-text,
            .answer-option.selected .answer-content,
            .answer-option.selected .colon {
                color: white;
            }

        .answer-option input[type="radio"] {
            margin: 0;
            width: 20px; /* Giảm từ 22px */
            height: 20px;
            cursor: pointer;
            accent-color: #87A878;
        }

        .answer-option label {
            display: flex;
            align-items: center;
            font-size: 0.95rem; /* Giảm từ 1rem */
            color: #2C3E50;
            margin: 0;
            gap: 8px;
            pointer-events: none;
            flex: 1;
        }

        .answer-option .label-text {
            font-weight: 700;
            color: white;
            min-width: 28px; /* Giảm từ 32px */
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1rem;
            background: linear-gradient(135deg, #2E5C8A 0%, #4A7BA7 100%);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(46, 92, 138, 0.18);
        }

        .answer-option:hover .label-text {
            background: white;
            color: #87A878;
        }

        .answer-option.selected .label-text {
            background: white;
            color: #87A878;
        }

        .answer-option .answer-content {
            font-weight: 400;
            color: #2C3E50;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .answer-option .colon {
            font-weight: 600;
            color: #5A6C7D;
        }

    /* ============================================
       PART 3/4/6/7 LAYOUT - Giảm padding
       ============================================ */
    .part3-container {
        display: flex;
        gap: 24px; /* Giảm từ 32px */
        background: linear-gradient(to bottom, #FFFFFF, #F9FAFB);
        border-radius: 12px;
        padding: 20px; /* Giảm từ 32px */
        box-shadow: 0 3px 12px rgba(46, 92, 138, 0.1);
        max-width: 1200px;
        margin: 0 auto 20px;
        border: 2px solid #E8DED2;
        border-left: 4px solid #87A878;
    }

    .part3-left {
        flex: 1;
        text-align: center;
        border-right: 2px solid #87A878;
        padding-right: 24px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        padding-left: 10px;
        scrollbar-width: thin;
        scrollbar-color: #87A878 rgba(255, 249, 230, 0.5);
    }

        .part3-left::-webkit-scrollbar {
            width: 5px;
        }

        .part3-left::-webkit-scrollbar-track {
            background: rgba(255, 249, 230, 0.5);
            border-radius: 8px;
        }

        .part3-left::-webkit-scrollbar-thumb {
            background: #87A878;
            border-radius: 8px;
        }

            .part3-left::-webkit-scrollbar-thumb:hover {
                background: #6B8E5F;
            }

        .part3-left .question-text {
            text-align: left;
        }

    .part3-right {
        flex: 1.2;
        display: flex;
        flex-direction: column;
        gap: 18px; /* Giảm từ 24px */
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        padding-left: 12px;
        scrollbar-width: thin;
        scrollbar-color: #87A878 rgba(255, 249, 230, 0.5);
    }

        .part3-right::-webkit-scrollbar {
            width: 5px;
        }

        .part3-right::-webkit-scrollbar-track {
            background: rgba(255, 249, 230, 0.5);
            border-radius: 8px;
        }

        .part3-right::-webkit-scrollbar-thumb {
            background: #87A878;
            border-radius: 8px;
        }

            .part3-right::-webkit-scrollbar-thumb:hover {
                background: #6B8E5F;
            }

    .sub-question {
        background: white;
        padding: 18px; /* Giảm từ 24px */
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(46, 92, 138, 0.06);
        border: 2px solid #E8DED2;
        border-left: 3px solid #87A878;
        transition: all 0.3s ease;
    }

        .sub-question:hover {
            border-left-width: 5px;
            box-shadow: 0 3px 10px rgba(135, 168, 120, 0.15);
        }

        .sub-question h4 {
            font-weight: 700;
            background: linear-gradient(90deg, #2E5C8A 0%, #4A7BA7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            font-size: 1.05rem; /* Giảm từ 1.125rem */
        }

            .sub-question h4 .question-content {
                font-weight: 400;
                color: #2C3E50;
                display: inline;
                margin-top: 6px;
                background: none;
                -webkit-text-fill-color: #2C3E50;
            }

    .sub-question-image {
        width: 150px; /* Nhỏ hơn cho sub-question */
        height: 150px; /* Hình vuông */
        object-fit: cover;
        border-radius: 8px;
        margin: 10px auto;
        display: block;
        box-shadow: 0 2px 6px rgba(46, 92, 138, 0.06);
        border: 2px solid #E8DED2;
    }

        .sub-question-image:hover {
            transform: scale(1.03);
        }

    .sub-question-audio {
        width: 100%;
        border-radius: 8px;
        background: linear-gradient(135deg, #FFF4E0 0%, #E8F4F8 100%);
        padding: 6px;
        margin-bottom: 12px;
        border: 2px solid #E8DED2;
    }

        .sub-question-audio:hover {
            transform: scale(1.01);
            box-shadow: 0 3px 10px rgba(46, 92, 138, 0.1);
        }

    /* ============================================
       MODAL STYLES
       ============================================ */
    .modal, .confirmation-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(46, 92, 138, 0.5);
        backdrop-filter: blur(8px);
        z-index: 1000;
        justify-content: center; /* Căn giữa theo chiều ngang */
        align-items: center; /* Căn giữa theo chiều dọc */
    }

        .modal.active, .confirmation-modal.active {
            display: flex; /* Quan trọng: phải là flex để justify-content và align-items hoạt động */
            animation: fadeIn 0.3s ease-out;
        }

    #confirm-submit-modal {
        display: none;
    }

        #confirm-submit-modal[style*="display: block"] {
            display: flex !important; /* Override inline style từ JavaScript */
        }
    .modal-content {
        background: linear-gradient(to bottom, #FFFFFF, #F9FAFB);
        border-radius: 14px;
        padding: 28px;
        max-width: 450px;
        width: 90%;
        text-align: center;
        box-shadow: 0 6px 24px rgba(46, 92, 138, 0.2);
        animation: zoomIn 0.3s ease-out;
        border: 2px solid #87A878;
    }

        .modal-title, .modal-content h3 {
            font-weight: 700;
            background: linear-gradient(90deg, #2E5C8A 0%, #4A7BA7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 14px;
            font-size: 1.3rem;
        }

        .modal-text, .modal-content p {
            font-size: 0.95rem;
            color: #5A6C7D;
            margin-bottom: 24px;
            line-height: 1.5;
        }

    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 14px;
    }

    .modal-btn {
        padding: 10px 28px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .confirm-btn {
        background: linear-gradient(135deg, #87A878 0%, #A8D8B9 100%);
        color: white;
    }

        .confirm-btn:hover {
            background: linear-gradient(135deg, #6B8E5F 0%, #87A878 100%);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(135, 168, 120, 0.25);
        }

    .cancel-btn {
        background: white;
        color: #E8956F;
        border: 2px solid #E8956F;
    }

        .cancel-btn:hover {
            background: #E8956F;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(232, 149, 111, 0.25);
        }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @@keyframes slideInDown {
        from

    {
        transform: translateY(-100%);
        opacity: 0;
    }

    to {
        transform: translateY(0);
        opacity: 1;
    }

    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
    }

    to {
        opacity: 1;
    }

    }

    @@keyframes fadeInUp {
        from

    {
        transform: translateY(20px);
        opacity: 0;
    }

    to {
        transform: translateY(0);
        opacity: 1;
    }

    }

    @@keyframes zoomIn {
        from

    {
        transform: scale(0.92);
        opacity: 0;
    }

    to {
        transform: scale(1);
        opacity: 1;
    }

    }

    @@keyframes slideIn {
        from

    {
        transform: translateY(-40px);
    }

    to {
        transform: translateY(0);
    }

    }

    /* ============================================
       RESPONSIVE DESIGN
       ============================================ */
    @@media (max-width: 768px) {
        .sidebar-left, .sidebar-right

    {
        width: 100%;
        height: auto;
        position: fixed;
        top: 50px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 100;
    }

    .sidebar-right {
        transform: translateX(100%);
    }

        .sidebar-left.active, .sidebar-right.active {
            transform: translateX(0);
        }

    .main-content {
        margin-left: 0;
        margin-right: 0;
        padding: 60px 12px 12px;
            scrollbar-width: thin;
            scrollbar-color: #87A878 rgba(255, 249, 230, 0.5);
    }

            .main-content::-webkit-scrollbar {
                width: 10px; /* Rộng hơn sidebar 1 chút để dễ kéo */
            }

            .main-content::-webkit-scrollbar-track {
                background: rgba(255, 249, 230, 0.5); /* Nền nhạt */
                border-radius: 10px;
            }

            .main-content::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #87A878 0%, #6B8E5F 100%); /* Gradient Xanh */
                border-radius: 10px;
                border: 2px solid transparent; /* Viền trong suốt tạo cảm giác nổi */
                background-clip: content-box;
            }

                .main-content::-webkit-scrollbar-thumb:hover {
                    background: linear-gradient(180deg, #6B8E5F 0%, #557C4B 100%); /* Đậm hơn khi hover */
                    border: 2px solid transparent;
                    background-clip: content-box;
                }
    .question-container {
        padding: 16px;
    }

    .part3-container {
        flex-direction: column;
        padding: 16px;
    }

    .part3-left {
        border-right: none;
        border-bottom: 2px solid #87A878;
        padding-right: 0;
        padding-bottom: 16px;
        max-height: 45vh;
    }

    .part3-right {
        max-height: 50vh;
        padding-left: 0;
    }

    .question-image, .sub-question-image {
        max-width: 280px;
    }

    .part-btn {
        font-size: 0.85rem;
        padding: 12px 10px;
        height: 100px;
    }

    .part-btn-icon {
        font-size: 1.7rem;
    }

    }
</style>