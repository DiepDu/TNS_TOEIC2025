@page
@model TNS_TOEICPart7.Areas.TOEICPart7.Pages.QuestionModel
@{
    Layout = "_Layout";
}

<link href="~/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    /* ===== ROOT VARIABLES ===== */
    :root {
        --primary-blue: #3498db;
        --success-green: #27ae60;
        --danger-red: #e74c3c;
        --warning-yellow: #f39c12;
        --info-cyan: #17a2b8;
        --purple: #9b59b6;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
        --radius-md: 12px;
    }

    /* ===== BREADCRUMB ===== */
    .breadcrumb-custom {
        background: #ffffff;
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-md);
        margin: -20px 0 20px -20px;
        box-shadow: var(--shadow-sm);
    }

        .breadcrumb-custom a {
            color: #4c4c4c;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

            .breadcrumb-custom a:hover {
                color: var(--primary-blue);
            }

        .breadcrumb-custom .current {
            color: maroon;
            font-weight: 600;
        }

        .breadcrumb-custom .return-link {
            color: var(--primary-blue);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .breadcrumb-custom .return-link:hover {
                color: #2980b9;
                text-decoration: underline;
            }

    /* ===== PAGE TITLE ===== */
    .page-title-container {
        text-align: center;
        margin: 1rem 0;
        padding: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
    }

    .page-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #ffffff;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* ===== CARDS ===== */
    .card {
        border-radius: var(--radius-md);
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
    }

        .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

    .card-header {
        font-weight: 600;
        font-size: 1rem;
        border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
        padding: 1rem 1.25rem;
        letter-spacing: 0.3px;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* ===== PURPLE CARD ===== */
    .border-purple {
        border-color: var(--purple) !important;
    }

    .bg-purple {
        background: linear-gradient(135deg, var(--purple) 0%, #8e44ad 100%);
    }

    /* ===== FORM CONTROLS ===== */
    .form-control, textarea {
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        padding: 0.75rem;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }

        .form-control:focus, textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

    /* ===== BUTTONS ===== */
    .btn {
        border-radius: 8px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        border: none;
        box-shadow: var(--shadow-sm);
    }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-blue) 0%, #2980b9 100%);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger-red) 0%, #c0392b 100%);
    }

    /* ===== SELECT2 STYLING ===== */
    .select2-container--bootstrap-5 .select2-selection {
        border: 2px solid #e0e0e0 !important;
        border-radius: 8px !important;
        padding: 0.5rem !important;
        min-height: 45px !important;
        transition: all 0.3s ease !important;
    }

    .select2-container--bootstrap-5.select2-container--focus .select2-selection,
    .select2-container--bootstrap-5.select2-container--open .select2-selection {
        border-color: var(--primary-blue) !important;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2) !important;
    }

    .select2-dropdown {
        border: 2px solid var(--primary-blue) !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    .select2-results__option--highlighted {
        background-color: var(--primary-blue) !important;
        color: white !important;
    }

    /* ===== INFO CARD ===== */
    .info-card .card-header {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.3s ease;
    }

        .info-card .card-header:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1e5a8e 100%) !important;
        }

    .info-card dt {
        font-weight: 600;
        color: #7f8c8d;
        font-size: 0.85rem;
    }

    .info-card dd {
        margin-bottom: 0.75rem;
        color: #2c3e50;
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* ===== IMAGE PREVIEW ===== */
    .img-preview {
        width: 161px;
        height: 161px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
        transition: transform 0.3s ease;
    }

        .img-preview:hover {
            transform: scale(1.05);
        }

    /* ===== MODAL ===== */
    .modal-content {
        border-radius: var(--radius-md);
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        border-top-left-radius: var(--radius-md);
        border-top-right-radius: var(--radius-md);
        background: linear-gradient(135deg, var(--primary-blue) 0%, #2980b9 100%);
    }

    #ModalConfirm .modal-header.bg-warning {
        background: linear-gradient(135deg, var(--warning-yellow) 0%, #e67e22 100%) !important;
    }

    #ModalConfirm .fa-trash-alt {
        animation: shake 0.5s ease-in-out;
    }

    @@keyframes shake {
        0%, 100%

    {
        transform: translateX(0);
    }

    25% {
        transform: translateX(-5px);
    }

    75% {
        transform: translateX(5px);
    }

    }

    /* ===== ANIMATIONS ===== */
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .card {
        animation: fadeIn 0.4s ease-out;
    }

    /* ===== RESPONSIVE ===== */
    @@media (max-width: 768px) {
        .card-body

    {
        padding: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    }
</style>

<!-- Breadcrumb -->
<div class="breadcrumb-custom">
    <a href="~/Index"><i class="fas fa-home me-2"></i>Home</a>
    <span class="mx-2">›</span>
    <a href="/TOEICPart7/QuestionList">TOEIC Part 7</a>
    <span class="mx-2">›</span>
    <span class="current">Question Editor</span>
    <span class="mx-2">·</span>
    <span class="return-link" onclick="returnToSource()">
        <i class="fas fa-arrow-left me-1"></i>Return
    </span>
</div>

<!-- Page Title -->
<div class="page-title-container">
    <h1 class="page-title">
        <i class="fas fa-edit me-2"></i>
        Question Editor
    </h1>
</div>

<!-- Main Content -->
<div class="row mt-3" style="font-size: 15px">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-body">
                <!-- Text Section -->
                <div class="mb-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-text-height me-2"></i> Text
                        </div>
                        <div class="card-body">
                            <textarea id="txtQuestionText" class="form-control" rows="5" placeholder="Enter question text here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Image Section (Show ONLY for QuestionSubList) -->
                <div class="mb-4" id="imageSection" style="display:none;">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <i class="fas fa-image me-2"></i> Image
                        </div>
                        <div class="card-body">
                            <img id="objQuestionImage" src="~/images/icon_Pic.png" class="img-fluid rounded mb-2"
                                 style="width: 161px; height: 161px; object-fit: cover;" />
                            <div id="FormUploadImage" class="mb-3">
                                <input id="txtUploadImage" class="form-control" type="file" accept="image/*">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Explanation Section -->
                <div class="mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-book-open me-2"></i> Explanation
                        </div>
                        <div class="card-body">
                            <textarea id="txtExplanation" class="form-control" rows="5" placeholder="Enter explanation here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Level Section -->
                <div class="mb-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-level-up-alt me-2"></i> Level (1-5)
                        </div>
                        <div class="card-body">
                            <input id="txtSkillLevel" type="number" class="form-control" placeholder="Enter level 1-5" min="1" max="5" />
                        </div>
                    </div>
                </div>

                <!-- Category Section -->
                <div class="mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-folder me-2"></i> Category
                        </div>
                        <div class="card-body">
                            <select id="ddlCategory" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Grammar Topic Section -->
                <div class="mb-4">
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <i class="fas fa-book me-2"></i> Grammar Topic
                        </div>
                        <div class="card-body">
                            <select id="ddlGrammarTopic" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Vocabulary Topic Section -->
                <div class="mb-4">
                    <div class="card border-dark">
                        <div class="card-header bg-dark text-white">
                            <i class="fas fa-spell-check me-2"></i> Vocabulary Topic
                        </div>
                        <div class="card-body">
                            <select id="ddlVocabularyTopic" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Error Type Section -->
                <div class="mb-4">
                    <div class="card border-light">
                        <div class="card-header bg-light text-dark border-bottom">
                            <i class="fas fa-exclamation-triangle me-2"></i> Error Type
                        </div>
                        <div class="card-body">
                            <select id="ddlErrorType" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Buttons -->
            <div class="card-footer bg-white text-end">
                <button type="button" id="btnDel" class="btn btn-danger me-2" onclick="btnDel_Click()">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
                <button type="button" id="btnUpdate" class="btn btn-primary me-2" onclick="btnUpdate_Click()">
                    <i class="fas fa-save me-2"></i>Update
                </button>
                <button type="button" id="btnCreate" class="btn btn-success" onclick="btnCreate_Click()">
                    <i class="fas fa-plus me-2"></i>Create
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-3">
        <!-- Ranking Card (Show ONLY for QuestionSubList) -->
        <div class="card shadow-sm border-purple mb-3" id="rankingCard" style="display: none;">
            <div class="card-header bg-purple text-white">
                <i class="fas fa-sort-numeric-up me-2"></i> Ranking
            </div>
            <div class="card-body p-2">
                <input id="txtRanking" type="number" class="form-control" value="0" min="1" max="7" style="font-size: 14px; padding: 5px;" />
            </div>
        </div>

        <!-- Information Card -->
        <div class="card shadow-sm border-primary info-card">
            <div class="card-header bg-primary text-white" onclick="toggleInfo()">
                <i class="fas fa-info-circle me-2"></i> Information
                <i class="fas fa-chevron-down float-end" id="infoToggleIcon"></i>
            </div>
            <div class="card-body" id="infoBody" style="display: none;">
                <dl class="row mb-0">
                    <dt class="col-5">Created On</dt>
                    <dd class="col-7" id="createdOn">N/A</dd>
                    <dt class="col-5">Created By</dt>
                    <dd class="col-7" id="createdBy">N/A</dd>
                    <dt class="col-5">Modified On</dt>
                    <dd class="col-7" id="modifiedOn">N/A</dd>
                    <dt class="col-5">Modified By</dt>
                    <dd class="col-7" id="modifiedBy">N/A</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="ModalConfirm" tabindex="-1" aria-labelledby="ModalConfirm_Label" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="ModalConfirm_Title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-trash-alt fa-3x text-danger me-3"></i>
                    <div>
                        <p class="mb-0 fw-bold">Are you sure you want to delete this question?</p>
                        <p class="mb-0 text-muted small">This action cannot be undone.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="ModalMessage" tabindex="-1" aria-labelledby="ModalMessage_Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ModalMessage_Title">Message</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center">
                    <div id="ModalMessage_Icon" class="me-3"></div>
                    <div id="ModalMessage_Content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Data -->
<div style="display: none">
    <div id="QuestionKey">@Model.QuestionKey</div>
    <div id="Parent">@Model.Parent</div>
    <div id="Source">@Model.Source</div>
</div>

<script src="~/lib/tinymce/tinymce.min.js"></script>
<script src="~/lib/jquery/jquery-3.7.0.js"></script>


@section Scripts {
    <script>
        // ===== GLOBAL VARIABLES =====
        let record = {};
        const roles = { create: true, read: true, update: true, delete: true };
        let tempImageFile = null;
        let editorsReady = false;

        // ===== INITIALIZATION =====
        $(document).ready(() => {
            const questionKey = $('#QuestionKey').text().trim();
            const parentKey = $('#Parent').text().trim();
            const source = $('#Source').text().trim();

            console.log('Source:', source, 'Parent:', parentKey, 'QuestionKey:', questionKey);

            // ✅ Show/Hide sections based on Source
            if (source === 'QuestionList') {
                // Main passage - NO image, NO ranking
                $('#imageSection').hide();
                $('#rankingCard').hide();
            } else if (source === 'QuestionSubList') {
                // Sub-question - HAS image, HAS ranking
                $('#imageSection').show();
                $('#rankingCard').show();
            } else {
                // Default - hide both
                $('#imageSection').hide();
                $('#rankingCard').hide();
            }

            // Initialize in sequence with Promise chain
            Promise.resolve()
                .then(() => initializeTinyMCE())
                .then(() => loadDropdowns())
                .then(() => initializeSelect2())
                .then(() => {
                    if (!questionKey || questionKey === 'undefined' || questionKey === '') {
                        record = { QuestionKey: null, Parent: parentKey || null };
                        console.log('✅ CREATE MODE - Parent set to:', record.Parent);
                        RecordView();
                        updateButtons();
                        loadInfoData({});
                    } else {
                        console.log('✅ UPDATE MODE - Reading existing question:', questionKey);
                        return Promise.all([
                            RecordRead(questionKey),
                            loadInformation(questionKey)
                        ]);
                    }
                })
                .then(() => {
                    // Setup file upload event listeners
                    setupFileUploadListeners();
                })
                .catch(error => {
                    console.error('Initialization error:', error);
                    alert('Error loading page. Please refresh.');
                });
        });

        // ===== TINYMCE INITIALIZATION =====
        function initializeTinyMCE() {
            return new Promise((resolve) => {
                let editorsInitialized = 0;
                const totalEditors = 2;

                const initEditor = (elementId) => {
                    tinymce.init({
                        selector: '#' + elementId,
                        plugins: 'advlist autolink lists link image charmap print preview',
                        toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent',
                        height: 200,
                        setup: function (editor) {
                            editor.on('init', function () {
                                editorsInitialized++;
                                if (editorsInitialized === totalEditors) {
                                    editorsReady = true;
                                    console.log('✅ TinyMCE editors ready');
                                    resolve();
                                }
                            });
                        }
                    });
                };

                initEditor('txtQuestionText');
                initEditor('txtExplanation');
            });
        }

        // ===== DROPDOWNS LOADING =====
        function loadDropdowns() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: '/TOEICPart7/Question?handler=LoadDropdowns',
                    contentType: 'application/json',
                    dataType: 'json'
                }).done(data => {
                    populateDropdown('#ddlCategory', data.categories, 'CategoryKey', 'CategoryName');
                    populateDropdown('#ddlGrammarTopic', data.grammarTopics, 'GrammarTopicID', 'TopicName');
                    populateDropdown('#ddlVocabularyTopic', data.vocabularyTopics, 'VocabularyTopicID', 'TopicName');
                    populateDropdown('#ddlErrorType', data.errorTypes, 'ErrorTypeID', 'ErrorDescription');
                    console.log('✅ Dropdowns loaded');
                    resolve();
                }).fail(error => {
                    console.error('Error loading dropdowns:', error);
                    alert('Error loading dropdowns: ' + error.responseText);
                    reject(error);
                });
            });
        }

        function populateDropdown(selector, data, valueField, textField) {
            const $dropdown = $(selector);
            $dropdown.empty();
            $dropdown.append('<option value="">Select...</option>');
            if (data && data.length > 0) {
                data.forEach(item => {
                    $dropdown.append(`<option value="${item[valueField]}">${item[textField]}</option>`);
                });
            }
        }

        // ===== SELECT2 INITIALIZATION =====
        function initializeSelect2() {
            return new Promise((resolve) => {
                try {
                    const select2Config = {
                        allowClear: true,
                        width: '100%',
                        theme: 'bootstrap-5'
                    };

                    $('#ddlCategory').select2({
                        ...select2Config,
                        placeholder: 'Search or select category...'
                    });

                    $('#ddlGrammarTopic').select2({
                        ...select2Config,
                        placeholder: 'Search or select grammar topic...'
                    });

                    $('#ddlVocabularyTopic').select2({
                        ...select2Config,
                        placeholder: 'Search or select vocabulary topic...'
                    });

                    $('#ddlErrorType').select2({
                        ...select2Config,
                        placeholder: 'Search or select error type...'
                    });

                    console.log('✅ Select2 initialized');
                    setTimeout(resolve, 100);
                } catch (error) {
                    console.error('Error initializing Select2:', error);
                    resolve();
                }
            });
        }

        // ===== RECORD READING =====
        function RecordRead(key) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: '/TOEICPart7/Question?handler=RecordRead',
                    data: JSON.stringify({ questionKey: key }),
                    contentType: 'application/json',
                    dataType: 'json'
                }).done(data => {
                    if (!data || !data.QuestionKey) {
                        record = { QuestionKey: null };
                    } else {
                        record = data;
                        console.log('✅ Record loaded - Parent:', record.Parent);
                    }
                    RecordView();
                    updateButtons();
                    resolve();
                }).fail(error => {
                    console.error('Error fetching record:', error);
                    record = { QuestionKey: null };
                    RecordView();
                    updateButtons();
                    reject(error);
                });
            });
        }

        // ===== RECORD VIEW =====
        function RecordView() {
            if (!editorsReady) {
                setTimeout(RecordView, 100);
                return;
            }

            const textEditor = tinymce.get('txtQuestionText');
            const explanationEditor = tinymce.get('txtExplanation');

            if (textEditor) {
                textEditor.setContent(record.QuestionText || '');
            }

            if (explanationEditor) {
                explanationEditor.setContent(record.Explanation || '');
            }

            $('#objQuestionImage').attr('src', record.QuestionImage || '/images/icon_Pic.png');

            // ✅ Chỉ hiển thị level nếu có giá trị >= 1, ngược lại để trống
            if (record.SkillLevel && record.SkillLevel > 0) {
                $('#txtSkillLevel').val(record.SkillLevel);
            } else {
                $('#txtSkillLevel').val('');
            }

            $('#txtRanking').val(record.Ranking || 0);

            // ✅ CẬP NHẬT hidden field Parent từ record (để đồng bộ)
            $('#Parent').text(record.Parent || '');
            console.log('✅ RecordView - Parent synced to hidden field:', record.Parent);

            setTimeout(() => {
                try {
                    $('#ddlCategory').val(record.Category || null).trigger('change.select2');
                    $('#ddlGrammarTopic').val(record.GrammarTopic || null).trigger('change.select2');
                    $('#ddlVocabularyTopic').val(record.VocabularyTopic || null).trigger('change.select2');
                    $('#ddlErrorType').val(record.ErrorType || null).trigger('change.select2');
                } catch (e) {
                    $('#ddlCategory').val(record.Category || '');
                    $('#ddlGrammarTopic').val(record.GrammarTopic || '');
                    $('#ddlVocabularyTopic').val(record.VocabularyTopic || '');
                    $('#ddlErrorType').val(record.ErrorType || '');
                }
            }, 150);
        }

        // ===== RECORD INPUT - ✅ FIXED PARENT BUG =====
        function RecordInput() {
            const textEditor = tinymce.get('txtQuestionText');
            const explanationEditor = tinymce.get('txtExplanation');

            record.QuestionText = textEditor ? textEditor.getContent() : '';
            record.Explanation = explanationEditor ? explanationEditor.getContent() : '';

            // ✅ Level: Chỉ gửi nếu >= 1, ngược lại gửi null
            const skillLevelValue = $('#txtSkillLevel').val();
            record.SkillLevel = (skillLevelValue && parseInt(skillLevelValue) >= 1)
                ? parseInt(skillLevelValue)
                : null;

            record.Ranking = parseInt($('#txtRanking').val()) || 0;
            record.Category = $('#ddlCategory').val() || null;
            record.GrammarTopic = $('#ddlGrammarTopic').val() || null;
            record.VocabularyTopic = $('#ddlVocabularyTopic').val() || null;
            record.ErrorType = $('#ddlErrorType').val() || null;

            // ✅ FIX: Chỉ set Parent khi CREATE (chưa có QuestionKey)
            // Khi UPDATE, giữ nguyên Parent từ record (đã load từ backend)
            if (!record.QuestionKey) {
                // CREATE mode - lấy Parent từ hidden field
                record.Parent = $('#Parent').text().trim() || null;
                console.log('✅ RecordInput (CREATE) - Set Parent to:', record.Parent);
            } else {
                // UPDATE mode - GIỮ NGUYÊN Parent từ record
                console.log('✅ RecordInput (UPDATE) - Keep existing Parent:', record.Parent);
            }
        }

        // ===== INFORMATION LOADING =====
        function loadInformation(questionKey) {
            return new Promise((resolve) => {
                $.ajax({
                    type: 'POST',
                    url: '/TOEICPart7/Question?handler=GetInfo',
                    data: JSON.stringify({ questionKey: questionKey }),
                    contentType: 'application/json',
                    dataType: 'json',
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }
                }).done(data => {
                    loadInfoData(data);
                    resolve();
                }).fail(error => {
                    console.error('Error loading info:', error);
                    loadInfoData({});
                    resolve();
                });
            });
        }

        function loadInfoData(record) {
            $('#createdOn').text(record.CreatedOn || 'N/A');
            $('#createdBy').text(record.CreatedBy || 'N/A');
            $('#modifiedOn').text(record.ModifiedOn || 'N/A');
            $('#modifiedBy').text(record.ModifiedBy || 'N/A');
        }

        // ===== CRUD OPERATIONS =====
        function handleOperation(handler, message, redirect = null) {
            $('#ModalMessage_Icon').html('<img src="/images/Waiting.gif" width="80px"/>');
            $('#ModalMessage_Content').html('Processing...');
            $('#ModalMessage').modal('show');
            RecordInput();

            console.log('🚀 Sending to backend:', {
                QuestionKey: record.QuestionKey,
                Parent: record.Parent,
                QuestionText: record.QuestionText?.substring(0, 50) + '...'
            });

            const formData = new FormData();
            formData.append('record', JSON.stringify(record));
            if (tempImageFile) formData.append('image', tempImageFile);

            $.ajax({
                type: 'POST',
                url: `/TOEICPart7/Question?handler=${handler}`,
                contentType: false,
                processData: false,
                data: formData
            }).done(data => {
                if (data.status === 'OK') {
                    $('#ModalMessage_Icon').html('<img src="/images/icon_success.png"/>');
                    $('#ModalMessage_Content').html(message);
                    record = data.record || record;
                    tempImageFile = null;
                    console.log('✅ Operation success - New record:', record);
                    RecordView();
                    updateButtons();
                    setTimeout(() => {
                        $('#ModalMessage').modal('hide');
                        if (redirect) window.location.href = redirect;
                    }, 2000);
                } else {
                    $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                    $('#ModalMessage_Content').html(data.message || 'Operation failed');
                    setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
                }
            }).fail(error => {
                $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                $('#ModalMessage_Content').html('Error: ' + error.responseText);
                setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
            });
        }

        function createRecord() {
            handleOperation('RecordCreate', 'Question created successfully');
        }

        function updateRecord() {
            handleOperation('RecordUpdate', 'Question updated successfully');
        }

        function deleteRecord() {
            $('#ModalConfirm').modal('show');
            $('#btnConfirmDelete').off('click');
            $('#btnConfirmDelete').on('click', function() {
                $('#ModalConfirm').modal('hide');

                $('#ModalMessage_Icon').html('<img src="/images/Waiting.gif" width="80px"/>');
                $('#ModalMessage_Content').html('Deleting...');
                $('#ModalMessage').modal('show');

                $.ajax({
                    type: 'POST',
                    url: '/TOEICPart7/Question?handler=RecordDel',
                    data: JSON.stringify({ questionKey: record.QuestionKey }),
                    contentType: 'application/json',
                    dataType: 'json'
                }).done(data => {
                    if (data.Status === 'OK') {
                        $('#ModalMessage_Icon').html('<img src="/images/icon_success.png"/>');
                        $('#ModalMessage_Content').html('Question deleted successfully');
                        setTimeout(() => {
                            $('#ModalMessage').modal('hide');
                            returnToSource();
                        }, 2000);
                    } else {
                        $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                        $('#ModalMessage_Content').html(data.Message || 'Delete failed');
                        setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
                    }
                }).fail(error => {
                    $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                    $('#ModalMessage_Content').html('Error: ' + error.responseText);
                    setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
                });
            });
        }

        // ===== UI HELPERS =====
        function updateButtons() {
            const isNew = !record.QuestionKey || record.QuestionKey === 'undefined' || record.QuestionKey === '';
            $('#btnCreate').toggle(roles.create && isNew);
            $('#btnUpdate').toggle(roles.update && !isNew);
            $('#btnDel').toggle(roles.delete && !isNew);
        }

        function toggleInfo() {
            $('#infoBody').slideToggle('fast', function() {
                const icon = $('#infoToggleIcon');
                if ($('#infoBody').is(':visible')) {
                    icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
                } else {
                    icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
                }
            });
        }

        // ===== FILE UPLOAD =====
        function setupFileUploadListeners() {
            const txtUploadImage = document.getElementById('txtUploadImage');
            if (txtUploadImage) {
                txtUploadImage.addEventListener('change', PreviewImage_Ajax);
            }
        }

        function PreviewImage_Ajax() {
            const fileInput = document.getElementById('txtUploadImage');
            if (fileInput && fileInput.files.length > 0) {
                tempImageFile = fileInput.files[0];
                const imageElement = document.getElementById('objQuestionImage');
                if (imageElement) {
                    imageElement.src = URL.createObjectURL(tempImageFile);
                }
            }
        }

        // ===== NAVIGATION =====
        function returnToSource() {
            const source = $('#Source').text().trim();
            if (source === 'QuestionSubList') {
                const parentKey = $('#Parent').text().trim();
                window.location.href = '/TOEICPart7/QuestionSubList?Key=' + parentKey;
            } else {
                window.location.href = '/TOEICPart7/QuestionList';
            }
        }

        // ===== BUTTON CLICK HANDLERS =====
        const btnDel_Click = deleteRecord;
        const btnUpdate_Click = updateRecord;
        const btnCreate_Click = createRecord;
    </script>
}