@page
@model TNS_TOEICPart5.Areas.TOEICPart5.Pages.QuestionModel
@{
    Layout = "_Layout";
}
<link href="~/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="~/css/select2.min.css" rel="stylesheet" />

<!-- Breadcrumb -->
<div class="breadcrumb-custom">
    <a href="~/Index"><i class="fas fa-home me-2"></i>Home</a>
    <span class="mx-2">›</span>
    <a href="/TOEICPart5/QuestionList">TOEIC Part 5</a>
    <span class="mx-2">›</span>
    <span class="current">Question Editor</span>
</div>

<!-- Main Content -->
<div class="row mt-3" style="font-size: 15px">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-body">
                <!-- Text Section -->
                <div class="mb-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-text-height me-2"></i> Text
                        </div>
                        <div class="card-body">
                            <textarea id="txtQuestionText" class="form-control" rows="5" placeholder="Enter question text here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Explanation Section -->
                <div class="mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-book-open me-2"></i> Explanation
                        </div>
                        <div class="card-body">
                            <textarea id="txtExplanation" class="form-control" rows="5" placeholder="Enter explanation here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Level Section -->
                <div class="mb-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-level-up-alt me-2"></i> Level (1-5)
                        </div>
                        <div class="card-body">
                            <input id="txtSkillLevel" type="number" class="form-control" placeholder="Enter level 1-5" min="1" max="5" />
                        </div>
                    </div>
                </div>

                <!-- Category Section -->
                <div class="mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-folder me-2"></i> Category
                        </div>
                        <div class="card-body">
                            <select id="ddlCategory" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Grammar Topic Section -->
                <div class="mb-4">
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <i class="fas fa-book me-2"></i> Grammar Topic
                        </div>
                        <div class="card-body">
                            <select id="ddlGrammarTopic" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Vocabulary Topic Section -->
                <div class="mb-4">
                    <div class="card border-dark">
                        <div class="card-header bg-dark text-white">
                            <i class="fas fa-spell-check me-2"></i> Vocabulary Topic
                        </div>
                        <div class="card-body">
                            <select id="ddlVocabularyTopic" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Error Type Section -->
                <div class="mb-4">
                    <div class="card border-light">
                        <div class="card-header bg-light text-dark border-bottom">
                            <i class="fas fa-exclamation-triangle me-2"></i> Error Type
                        </div>
                        <div class="card-body">
                            <select id="ddlErrorType" class="form-control custom-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Buttons -->
            <div class="card-footer bg-white text-end">
                <button type="button" id="btnDel" class="btn btn-danger me-2" onclick="btnDel_Click()">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
                <button type="button" id="btnUpdate" class="btn btn-primary me-2" onclick="btnUpdate_Click()">
                    <i class="fas fa-save me-2"></i>Update
                </button>
                <button type="button" id="btnCreate" class="btn btn-success" onclick="btnCreate_Click()">
                    <i class="fas fa-plus me-2"></i>Create
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="card shadow-sm border-primary info-card">
            <div class="card-header bg-primary text-white" onclick="toggleInfo()">
                <i class="fas fa-info-circle me-2"></i> Information
                <i class="fas fa-chevron-down float-end" id="infoToggleIcon"></i>
            </div>
            <div class="card-body" id="infoBody" style="display: none;">
                <dl class="row mb-0">
                    <dt class="col-5">Created On</dt>
                    <dd class="col-7" id="createdOn">N/A</dd>
                    <dt class="col-5">Created By</dt>
                    <dd class="col-7" id="createdBy">N/A</dd>
                    <dt class="col-5">Modified On</dt>
                    <dd class="col-7" id="modifiedOn">N/A</dd>
                    <dt class="col-5">Modified By</dt>
                    <dd class="col-7" id="modifiedBy">N/A</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="ModalMessage" tabindex="-1" aria-labelledby="ModalMessage_Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ModalMessage_Title">Message</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center">
                    <div id="ModalMessage_Icon" class="me-3"></div>
                    <div id="ModalMessage_Content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div style="display: none">
    <div id="QuestionKey">@Model.QuestionKey</div>
</div>

<script src="~/lib/tinymce/tinymce.min.js"></script>
<script src="~/lib/jquery/jquery-3.7.0.js"></script>
<script src="~/js/editor.js"></script>

@section Scripts {
    <script>
        // ===== GLOBAL VARIABLES =====
        let record = {};
        const roles = { create: true, read: true, update: true, delete: true };
        let editorsReady = false;

        // ===== INITIALIZATION =====
        $(document).ready(() => {
            const questionKey = $('#QuestionKey').text().trim();

            // Initialize in sequence with Promise chain
            Promise.resolve()
                .then(() => initializeTinyMCE())
                .then(() => loadDropdowns())
                .then(() => initializeSelect2())
                .then(() => {
                    if (!questionKey || questionKey === 'undefined' || questionKey === '') {
                        record = { QuestionKey: null };
                        RecordView();
                        updateButtons();
                        loadInfoData({});
                    } else {
                        return Promise.all([
                            RecordRead(questionKey),
                            loadInformation(questionKey)
                        ]);
                    }
                })
                .catch(error => {
                    console.error('Initialization error:', error);
                    alert('Error loading page. Please refresh.');
                });
        });

        // ===== TINYMCE INITIALIZATION =====
        function initializeTinyMCE() {
            return new Promise((resolve) => {
                let editorsInitialized = 0;
                const totalEditors = 2;

                const initEditor = (elementId) => {
                    tinymce.init({
                        selector: '#' + elementId,
                        plugins: 'advlist autolink lists link image charmap print preview',
                        toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent',
                        height: 200,
                        setup: function (editor) {
                            editor.on('init', function () {
                                editorsInitialized++;
                                if (editorsInitialized === totalEditors) {
                                    editorsReady = true;
                                    resolve();
                                }
                            });
                        }
                    });
                };

                initEditor('txtQuestionText');
                initEditor('txtExplanation');
            });
        }

        // ===== DROPDOWNS LOADING =====
        function loadDropdowns() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: '/TOEICPart5/Question?handler=LoadDropdowns',
                    contentType: 'application/json',
                    dataType: 'json'
                }).done(data => {
                    populateDropdown('#ddlCategory', data.categories, 'CategoryKey', 'CategoryName');
                    populateDropdown('#ddlGrammarTopic', data.grammarTopics, 'GrammarTopicID', 'TopicName');
                    populateDropdown('#ddlVocabularyTopic', data.vocabularyTopics, 'VocabularyTopicID', 'TopicName');
                    populateDropdown('#ddlErrorType', data.errorTypes, 'ErrorTypeID', 'ErrorDescription');
                    resolve();
                }).fail(error => {
                    console.error('Error loading dropdowns:', error);
                    alert('Error loading dropdowns: ' + error.responseText);
                    reject(error);
                });
            });
        }

        function populateDropdown(selector, data, valueField, textField) {
            const $dropdown = $(selector);
            $dropdown.empty();
            $dropdown.append('<option value="">Select...</option>');
            if (data && data.length > 0) {
                data.forEach(item => {
                    $dropdown.append(`<option value="${item[valueField]}">${item[textField]}</option>`);
                });
            }
        }

        // ===== SELECT2 INITIALIZATION =====
        function initializeSelect2() {
            return new Promise((resolve) => {
                try {
                    const select2Config = {
                        allowClear: true,
                        width: '100%',
                        theme: 'bootstrap-5'
                    };

                    $('#ddlCategory').select2({
                        ...select2Config,
                        placeholder: 'Search or select category...'
                    });

                    $('#ddlGrammarTopic').select2({
                        ...select2Config,
                        placeholder: 'Search or select grammar topic...'
                    });

                    $('#ddlVocabularyTopic').select2({
                        ...select2Config,
                        placeholder: 'Search or select vocabulary topic...'
                    });

                    $('#ddlErrorType').select2({
                        ...select2Config,
                        placeholder: 'Search or select error type...'
                    });

                    setTimeout(resolve, 100);
                } catch (error) {
                    console.error('Error initializing Select2:', error);
                    resolve();
                }
            });
        }

        // ===== RECORD READING =====
        function RecordRead(key) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: '/TOEICPart5/Question?handler=RecordRead',
                    data: JSON.stringify({ questionKey: key }),
                    contentType: 'application/json',
                    dataType: 'json'
                }).done(data => {
                    if (!data || !data.QuestionKey) {
                        record = { QuestionKey: null };
                    } else {
                        record = data;
                    }
                    RecordView();
                    updateButtons();
                    resolve();
                }).fail(error => {
                    console.error('Error fetching record:', error);
                    record = { QuestionKey: null };
                    RecordView();
                    updateButtons();
                    reject(error);
                });
            });
        }

        // ===== RECORD VIEW =====
        function RecordView() {
            if (!editorsReady) {
                setTimeout(RecordView, 100);
                return;
            }

            // TinyMCE
            const textEditor = tinymce.get('txtQuestionText');
            const explanationEditor = tinymce.get('txtExplanation');

            if (textEditor) {
                textEditor.setContent(record.QuestionText || '');
            }

            if (explanationEditor) {
                explanationEditor.setContent(record.Explanation || '');
            }

            // Skill Level
            if (record.SkillLevel && record.SkillLevel > 0) {
                $('#txtSkillLevel').val(record.SkillLevel);
            } else {
                $('#txtSkillLevel').val('');
            }

            // Select2 dropdowns
            setTimeout(() => {
                try {
                    $('#ddlCategory').val(record.Category || null).trigger('change.select2');
                    $('#ddlGrammarTopic').val(record.GrammarTopic || null).trigger('change.select2');
                    $('#ddlVocabularyTopic').val(record.VocabularyTopic || null).trigger('change.select2');
                    $('#ddlErrorType').val(record.ErrorType || null).trigger('change.select2');
                } catch (e) {
                    $('#ddlCategory').val(record.Category || '');
                    $('#ddlGrammarTopic').val(record.GrammarTopic || '');
                    $('#ddlVocabularyTopic').val(record.VocabularyTopic || '');
                    $('#ddlErrorType').val(record.ErrorType || '');
                }
            }, 150);
        }

        // ===== RECORD INPUT =====
        function RecordInput() {
            const textEditor = tinymce.get('txtQuestionText');
            const explanationEditor = tinymce.get('txtExplanation');

            record.QuestionText = textEditor ? textEditor.getContent() : '';
            record.Explanation = explanationEditor ? explanationEditor.getContent() : '';

            const skillLevelValue = $('#txtSkillLevel').val();
            record.SkillLevel = (skillLevelValue && parseInt(skillLevelValue) >= 1)
                ? parseInt(skillLevelValue)
                : null;

            record.Category = $('#ddlCategory').val() || null;
            record.GrammarTopic = $('#ddlGrammarTopic').val() || null;
            record.VocabularyTopic = $('#ddlVocabularyTopic').val() || null;
            record.ErrorType = $('#ddlErrorType').val() || null;
        }

        // ===== INFORMATION LOADING =====
        function loadInformation(questionKey) {
            return new Promise((resolve) => {
                $.ajax({
                    type: 'POST',
                    url: '/TOEICPart5/Question?handler=GetInfo',
                    data: JSON.stringify({ questionKey: questionKey }),
                    contentType: 'application/json',
                    dataType: 'json',
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }
                }).done(data => {
                    loadInfoData(data);
                    resolve();
                }).fail(error => {
                    console.error('Error loading info:', error);
                    loadInfoData({});
                    resolve();
                });
            });
        }

        function loadInfoData(record) {
            $('#createdOn').text(record.CreatedOn || 'N/A');
            $('#createdBy').text(record.CreatedBy || 'N/A');
            $('#modifiedOn').text(record.ModifiedOn || 'N/A');
            $('#modifiedBy').text(record.ModifiedBy || 'N/A');
        }

        // ===== CRUD OPERATIONS =====
        function handleOperation(handler, message, redirect = null) {
            $('#ModalMessage_Icon').html('<img src="/images/Waiting.gif" width="80px"/>');
            $('#ModalMessage_Content').html('Processing...');
            $('#ModalMessage').modal('show');
            RecordInput();

            const formData = new FormData();
            formData.append('record', JSON.stringify(record));

            $.ajax({
                type: 'POST',
                url: `/TOEICPart5/Question?handler=${handler}`,
                contentType: false,
                processData: false,
                data: formData
            }).done(data => {
                if (data.status === 'OK') {
                    $('#ModalMessage_Icon').html('<img src="/images/icon_success.png"/>');
                    $('#ModalMessage_Content').html(message);
                    record = data.record || record;
                    RecordView();
                    updateButtons();
                    setTimeout(() => {
                        $('#ModalMessage').modal('hide');
                        if (redirect) window.location.href = redirect;
                    }, 2000);
                } else {
                    $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                    $('#ModalMessage_Content').html(data.message || 'Operation failed');
                    setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
                }
            }).fail(error => {
                $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                $('#ModalMessage_Content').html('Error: ' + error.responseText);
                setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
            });
        }

        function createRecord() {
            handleOperation('RecordCreate', 'Question created successfully');
        }

        function updateRecord() {
            handleOperation('RecordUpdate', 'Question updated successfully');
        }

        function deleteRecord() {
            if (!confirm('Are you sure you want to delete this question?')) return;

            $('#ModalMessage_Icon').html('<img src="/images/Waiting.gif" width="80px"/>');
            $('#ModalMessage_Content').html('Deleting...');
            $('#ModalMessage').modal('show');

            $.ajax({
                type: 'POST',
                url: '/TOEICPart5/Question?handler=RecordDel',
                data: JSON.stringify({ questionKey: record.QuestionKey }),
                contentType: 'application/json',
                dataType: 'json'
            }).done(data => {
                if (data.Status === 'OK') {
                    $('#ModalMessage_Icon').html('<img src="/images/icon_success.png"/>');
                    $('#ModalMessage_Content').html('Question deleted successfully');
                    setTimeout(() => {
                        $('#ModalMessage').modal('hide');
                        window.location.href = '/TOEICPart5/QuestionList';
                    }, 2000);
                } else {
                    $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                    $('#ModalMessage_Content').html(data.Message || 'Delete failed');
                    setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
                }
            }).fail(error => {
                $('#ModalMessage_Icon').html('<img src="/images/icon_error.png"/>');
                $('#ModalMessage_Content').html('Error: ' + error.responseText);
                setTimeout(() => $('#ModalMessage').modal('hide'), 2000);
            });
        }

        // ===== UI HELPERS =====
        function updateButtons() {
            const isNew = !record.QuestionKey || record.QuestionKey === 'undefined' || record.QuestionKey === '';
            $('#btnCreate').toggle(roles.create && isNew);
            $('#btnUpdate').toggle(roles.update && !isNew);
            $('#btnDel').toggle(roles.delete && !isNew);
        }

        function toggleInfo() {
            $('#infoBody').slideToggle('fast', function() {
                const icon = $('#infoToggleIcon');
                if ($('#infoBody').is(':visible')) {
                    icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
                } else {
                    icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
                }
            });
        }

        // ===== BUTTON CLICK HANDLERS =====
        const btnDel_Click = deleteRecord;
        const btnUpdate_Click = updateRecord;
        const btnCreate_Click = createRecord;
    </script>
}

<style>
    /* ===== ROOT VARIABLES ===== */
    :root {
        --primary-blue: #3498db;
        --success-green: #27ae60;
        --danger-red: #e74c3c;
        --warning-yellow: #f39c12;
        --info-cyan: #17a2b8;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
        --radius-md: 12px;
    }

    /* ===== BREADCRUMB ===== */
    .breadcrumb-custom {
        background: #ffffff;
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-md);
        margin: -20px 0 20px -20px;
        box-shadow: var(--shadow-sm);
    }

        .breadcrumb-custom a {
            color: #4c4c4c;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

            .breadcrumb-custom a:hover {
                color: var(--primary-blue);
            }

        .breadcrumb-custom .current {
            color: maroon;
            font-weight: 600;
        }

    /* ===== CARDS ===== */
    .card {
        border-radius: var(--radius-md);
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
    }

        .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

    .card-header {
        font-weight: 600;
        font-size: 1rem;
        border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
        padding: 1rem 1.25rem;
        letter-spacing: 0.3px;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* ===== FORM CONTROLS ===== */
    .form-control, textarea, .custom-select {
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        padding: 0.75rem;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }

        .form-control:focus, textarea:focus, .custom-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

    input[type="number"] {
        -moz-appearance: textfield;
    }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 40px;
        }

    /* ===== BUTTONS ===== */
    .btn {
        border-radius: 8px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        border: none;
        box-shadow: var(--shadow-sm);
    }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-blue) 0%, #2980b9 100%);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger-red) 0%, #c0392b 100%);
    }

    /* ===== SELECT2 STYLING ===== */
    .select2-container--bootstrap-5 .select2-selection {
        border: 2px solid #e0e0e0 !important;
        border-radius: 8px !important;
        padding: 0.5rem !important;
        min-height: 45px !important;
        transition: all 0.3s ease !important;
    }

    .select2-container--bootstrap-5.select2-container--focus .select2-selection,
    .select2-container--bootstrap-5.select2-container--open .select2-selection {
        border-color: var(--primary-blue) !important;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2) !important;
    }

    .select2-dropdown {
        border: 2px solid var(--primary-blue) !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    .select2-results__option--highlighted {
        background-color: var(--primary-blue) !important;
        color: white !important;
    }

    /* ===== INFO SIDEBAR ===== */
    .info-card .card-header {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.3s ease;
    }

        .info-card .card-header:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1e5a8e 100%) !important;
        }

    .info-card dt {
        font-weight: 600;
        color: #7f8c8d;
        font-size: 0.85rem;
    }

    .info-card dd {
        margin-bottom: 0.75rem;
        color: #2c3e50;
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* ===== MODAL ===== */
    .modal-content {
        border-radius: var(--radius-md);
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        border-top-left-radius: var(--radius-md);
        border-top-right-radius: var(--radius-md);
        background: linear-gradient(135deg, var(--primary-blue) 0%, #2980b9 100%);
    }

    /* ===== ANIMATIONS ===== */
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .card {
        animation: fadeIn 0.4s ease-out;
    }

    /* ===== RESPONSIVE ===== */
    @@media (max-width: 768px) {
        .card-body

    {
        padding: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    }
</style>