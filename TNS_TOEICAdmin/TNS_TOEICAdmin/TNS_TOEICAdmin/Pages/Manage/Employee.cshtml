@page
@model TNS_TOEICAdmin.Pages.Manage.EmployeeModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Employee Management";
}

<style>
    body {
        background: linear-gradient(135deg, #E5F9FF 0%, #D1F1FF 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #2C3E50;
        line-height: 1.6;
    }

    .container {
        background: #FFF9E5;
        border-radius: 20px;
        padding: 30px;
        margin: 40px auto;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        max-width: 1400px;
        transition: box-shadow 0.3s ease;
    }

        .container:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
        }

    h2 {
        color: #2C3E50;
        font-weight: 700;
        font-size: 28px;
        margin-bottom: 25px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        background: linear-gradient(90deg, #2C3E50, #3498DB);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .search-container {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: nowrap;
        justify-content: space-between;
        width: 100%;
    }

    .search-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .search-input, .form-control {
        border-radius: 12px;
        border: 2px solid #3498DB;
        background-color: #FFFFFF;
        padding: 10px 15px;
        transition: all 0.4s ease;
        flex-grow: 1;
        min-width: 150px;
    }

        .search-input:focus, .form-control:focus {
            border-color: #2980B9;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.4);
            background-color: #F9FBFF;
            outline: none;
        }

    .btn-add, .btn-search, .btn-save, .btn-cancel, #loadMoreBtn {
        border-radius: 30px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        position: relative;
        overflow: hidden;
    }

        .btn-add::after, .btn-search::after, .btn-save::after, .btn-cancel::after, #loadMoreBtn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s ease, height 0.5s ease;
        }

        .btn-add:hover::after, .btn-search:hover::after, .btn-save:hover::after, .btn-cancel:hover::after, #loadMoreBtn:hover::after {
            width: 200px;
            height: 200px;
        }

        .btn-add:active, .btn-search:active, .btn-save:active, .btn-cancel:active, #loadMoreBtn:active {
            transform: scale(0.95);
        }

    .btn-add {
        background: linear-gradient(45deg, #3498DB, #5DADE2);
        border: none;
        color: #FFFFFF;
    }

        .btn-add:hover {
            background: linear-gradient(45deg, #2980B9, #4D94DB);
            transform: translateY(-4px) scale(1.08) rotate(2deg);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
            color: #FFFFFF;
        }

    .btn-search {
        background: linear-gradient(45deg, #F1C40F, #F7DC6F);
        border: none;
        color: #2C3E50;
        width: 60px;
        height: 60px;
        padding: 0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

        .btn-search:hover {
            background: linear-gradient(45deg, #D4AC0D, #E4C107);
            transform: translateY(-4px) scale(1.08);
            box-shadow: 0 8px 20px rgba(241, 196, 15, 0.4);
        }

    #loadMoreBtn {
        background: linear-gradient(45deg, #F1C40F, #F7DC6F);
        border: none;
        color: #2C3E50;
        width: auto;
        padding: 12px 24px;
        border-radius: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        #loadMoreBtn:hover {
            background: linear-gradient(45deg, #D4AC0D, #E4C107);
            transform: translateY(-4px) scale(1.08) rotate(2deg);
            box-shadow: 0 8px 20px rgba(241, 196, 15, 0.4);
        }

    .load-more-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-top: 20px;
    }

    .btn-save {
        background: linear-gradient(45deg, #27AE60, #52BE80);
        border: none;
        color: #FFFFFF;
    }

        .btn-save:hover {
            background: linear-gradient(45deg, #219653, #48A368);
            transform: translateY(-4px) scale(1.08) rotate(2deg);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }

    .btn-cancel {
        background: linear-gradient(45deg, #95A5A6, #BDC3C7);
        border: none;
        color: #2C3E50;
    }

        .btn-cancel:hover {
            background: linear-gradient(45deg, #7F8C8D, #A6B1B2);
            transform: translateY(-4px) scale(1.08) rotate(2deg);
            box-shadow: 0 8px 20px rgba(149, 165, 166, 0.4);
        }

    .btn-action {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0 4px;
        font-size: 16px;
        border: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

        .btn-action::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s ease, height 0.5s ease;
        }

        .btn-action:hover::after {
            width: 100px;
            height: 100px;
        }

        .btn-action:active {
            transform: scale(0.9);
        }

        .btn-action i {
            margin: 0;
        }

    .btn-edit {
        background: linear-gradient(45deg, #F1C40F, #F7DC6F);
        color: #2C3E50;
    }

        .btn-edit:hover {
            background: linear-gradient(45deg, #D4AC0D, #E4C107);
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 20px rgba(241, 196, 15, 0.4);
        }

    .btn-delete {
        background: linear-gradient(45deg, #E74C3C, #F1948A);
        color: #FFFFFF;
    }

        .btn-delete:hover {
            background: linear-gradient(45deg, #C0392B, #E57373);
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
        }

    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    .table-container {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden; /* ← BỎ SCROLL NGANG */
        position: relative;
        background: #FFFFFF;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    }

    .table {
        width: 100%;
        background: #FFFFFF;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 0;
    }

        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
        }

        .table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            color: #FFFFFF;
            text-align: center;
            padding: 12px;
            font-weight: 600;
            font-size: 15px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border-bottom: 2px solid #1e3c72;
        }

            .table th:hover {
                background: linear-gradient(135deg, #2a5298 0%, #3d5a9e 50%, #8a94a8 100%);
                transform: translateY(-1px);
            }

            .table th:first-child {
                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
                box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.15);
            }

                .table th:first-child:hover {
                    background: linear-gradient(135deg, #2a5298 0%, #3d5a9e 50%, #8a94a8 100%);
                }

        .table td {
            background: #FFFFFF;
            vertical-align: middle;
            padding: 12px;
            border-bottom: 1px solid #ECF0F1;
            font-size: 14px;
            color: #2C3E50;
            transition: all 0.3s ease;
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

            .table tbody tr:hover {
                background: linear-gradient(90deg, #F8FAFF, #EBF5FF);
                box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
                transform: scale(1.002);
            }

        /* Employee ID - Nổi bật */
        .table td:nth-child(1) {
            font-weight: 600;
            color: #2980B9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Full Name - Đậm hơn */
        .table td:nth-child(2) {
            font-weight: 600;
            color: #2C3E50;
        }

        /* Department - Màu phụ */
        .table td:nth-child(3) {
            color: #7F8C8D;
            font-weight: 500;
        }

        /* Email - Màu xanh dương */
        .table td:nth-child(4) {
            color: #3498DB;
            font-style: italic;
        }

        /* Status - Badge styling */
        .table td:nth-child(5) {
            font-weight: 600;
            text-align: center;
        }
    /* Status Badge Styling */
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-active {
        background: linear-gradient(135deg, #27AE60, #52BE80);
        color: #FFFFFF;
        box-shadow: 0 2px 6px rgba(39, 174, 96, 0.3);
    }

    .status-inactive {
        background: linear-gradient(135deg, #E74C3C, #EC7063);
        color: #FFFFFF;
        box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
    }

    .table-container::-webkit-scrollbar {
        width: 8px;
    }

    .table-container::-webkit-scrollbar-track {
        background: #ECF0F1;
        border-radius: 10px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: #3498DB;
        border-radius: 10px;
    }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #2980B9;
        }

    .modal-content {
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border: none;
    }

    .modal-header {
        background: linear-gradient(90deg, #3498DB, #5DADE2);
        color: #FFFFFF;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        padding: 15px 20px;
    }

    .modal-body {
        background: #FFF9E5;
        padding: 20px;
    }

    .modal-title {
        font-size: 22px;
        font-weight: 600;
    }

    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 320px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        padding: 15px 20px;
        font-size: 16px;
    }

    .alert-success {
        background: linear-gradient(45deg, #27AE60, #52BE80);
        color: #FFFFFF;
    }

    .alert-danger {
        background: linear-gradient(45deg, #E74C3C, #F1948A);
        color: #FFFFFF;
    }
    /* Pagination Styling */
    .pagination {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        list-style: none;
        padding: 0;
    }

        .pagination .page-link {
            border-radius: 50%;
            margin: 0 6px;
            color: #3498DB;
            border: 2px solid #3498DB;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: #FFFFFF;
            font-weight: 600;
            cursor: pointer;
        }

            .pagination .page-link:hover {
                background: #ECF0F1;
                color: #2980B9;
                transform: translateY(-2px);
            }

        .pagination .active .page-link {
            background: #3498DB;
            color: #FFFFFF;
            border-color: #3498DB;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .pagination .disabled .page-link {
            color: #BDC3C7;
            border-color: #ECF0F1;
            cursor: not-allowed;
            background: #F8F9FA;
        }

            .pagination .disabled .page-link:hover {
                background: #F8F9FA;
                transform: none;
            }
</style>

<div class="container">
    <h2><i class="fas fa-users me-2"></i>Employee Management</h2>
    <div class="search-container">
        <button class="btn btn-add" onclick="showAddModal()"><i class="fas fa-plus me-2"></i>Add Employee</button>
        <div class="search-group">
            <input type="text" class="form-control search-input" id="searchInput" placeholder="Search by name..." />
            <select class="form-control" id="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option> <!-- Sửa 'activate' thành 'active' -->
                <option value="inactive">Inactive</option> <!-- Sửa 'inactivate' thành 'inactive' -->
            </select>

        </div>
    </div>

    <div class="table-container">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Full Name</th>
                    <th>Department</th>
                    <th>Company Email</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="employeeTableBody"></tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="employeeModalLabel">Add Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <input type="hidden" id="employeeKey" name="employeeKey" />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="employeeID" class="form-label">Employee ID</label>
                            <input type="text" class="form-control" id="employeeID" name="employeeID" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="departmentKey" class="form-label">Department</label>
                            <select class="form-control" id="departmentKey" name="departmentKey">
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyEmail" class="form-label">Company Email</label>
                            <input type="email" class="form-control" id="companyEmail" name="companyEmail" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="startingDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startingDate" name="startingDate" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="leavingDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="leavingDate" name="leavingDate" />
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-save"><i class="fas fa-save me-2"></i>Save</button>
                        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" class="mb-0" style="white-space: pre-line;">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmBtn">
                    <i class="fas fa-check me-2"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        let employees = [];
        let departments = [];
        let currentPage = 1;
        const pageSize = 10;
        let searchTerm = '';
        let statusFilter = '';
        let isEditMode = false;
        let totalEmployees = 0;

        // ===== DEBOUNCE HELPER =====
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // ===== AUTO-SEARCH FUNCTION =====
        const autoSearch = debounce(function() {
            const searchValue = $('#searchInput').val().trim();
            const statusValue = $('#statusFilter').val();
            loadEmployees(1, searchValue, statusValue);
        }, 400);

        $(document).ready(function () {
            loadEmployees();
            loadDepartments();
            $('.btn-add').on('click', showAddModal);

            // ✅ AUTO-SEARCH khi gõ
            $('#searchInput').on('keyup', autoSearch);
            $('#statusFilter').on('change', autoSearch);

            // ✅ Trigger search khi nhấn Enter
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    autoSearch();
                }
            });
        });

        // ===== LOAD EMPLOYEES WITH PAGINATION =====
        function loadEmployees(page = 1, search = '', status = '') {
            currentPage = page;
            searchTerm = search;
            statusFilter = status;

            const dataToSend = {
                page: currentPage,
                pageSize: pageSize,
                search: searchTerm,
                status: statusFilter
            };

            $.ajax({
                url: '/Manage/Employee?handler=GetEmployees',
                method: 'GET',
                data: dataToSend,
                cache: false,
                success: function (response) {
                    if (response && response.data) {
                        employees = Array.isArray(response.data) ? response.data : [];
                        totalEmployees = response.totalCount || 0;
                        renderEmployees();
                        renderPagination();
                    } else {
                        employees = [];
                        totalEmployees = 0;
                        renderEmployees();
                        renderPagination();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading employees:', error);
                    showAlert('danger', 'Failed to load employees.');
                }
            });
        }

        // ===== RENDER EMPLOYEES =====
        function renderEmployees() {
            const tbody = $('#employeeTableBody');
            tbody.empty();

            if (employees.length > 0) {
                employees.forEach(emp => {
                    const currentDate = new Date();
                    const leavingDate = emp.LeavingDate ? new Date(emp.LeavingDate) : null;
                    const isInactivate = leavingDate && currentDate > leavingDate;

                    const statusBadge = isInactivate
                        ? '<span class="status-badge status-inactive">Inactive</span>'
                        : '<span class="status-badge status-active">Active</span>';

                    const row = `<tr>
                                <td>${emp.EmployeeID || 'N/A'}</td>
                                <td>${(emp.LastName || '') + ' ' + (emp.FirstName || '')}</td>
                                <td>${emp.DepartmentName || '<span style="color: #95A5A6;">No Department</span>'}</td>
                                <td>${emp.CompanyEmail || '<span style="color: #95A5A6;">N/A</span>'}</td>
                                <td>${statusBadge}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-action btn-edit" onclick="showEditModal('${emp.EmployeeKey}')" title="Edit Employee"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-action btn-delete" onclick="deleteEmployee('${emp.EmployeeKey}', ${isInactivate ? 'true' : 'false'})" title="Delete Employee"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="6" class="text-center text-muted p-4">No employees found</td></tr>');
            }
        }

        // ===== RENDER PAGINATION =====
        function renderPagination() {
            const totalPages = Math.ceil(totalEmployees / pageSize);
            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) return; // Không hiển thị nếu chỉ 1 trang

            // Previous button
            pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage > 1 ? `loadEmployees(${currentPage - 1}, '${searchTerm}', '${statusFilter}')` : ''}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadEmployees(${i}, '${searchTerm}', '${statusFilter}')">${i}</a>
                    </li>
                `);
            }

            // Next button
            pagination.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage < totalPages ? `loadEmployees(${currentPage + 1}, '${searchTerm}', '${statusFilter}')` : ''}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `);
        }

        function loadDepartments() {
            $.ajax({
                url: '/Manage/Employee?handler=GetDepartments',
                method: 'GET',
                success: function (data) {
                    departments = Array.isArray(data) ? data : [];
                    populateDepartmentDropdown();
                },
                error: function () {
                    showAlert('danger', 'Failed to load departments.');
                }
            });
        }

        function showAddModal() {
            isEditMode = false;
            $('#employeeModalLabel').text('Add Employee');
            $('#employeeForm')[0].reset();
            $('#employeeKey').val('');
            populateDepartmentDropdown();
            $('#employeeModal').modal('show');
        }

        function showEditModal(employeeKey) {
            const employee = employees.find(emp => emp.EmployeeKey === employeeKey);
            if (employee) {
                isEditMode = true;
                $('#employeeModalLabel').text('Edit Employee');
                $('#employeeKey').val(employee.EmployeeKey);
                $('#employeeID').val(employee.EmployeeID);
                $('#lastName').val(employee.LastName);
                $('#firstName').val(employee.FirstName);
                $('#companyEmail').val(employee.CompanyEmail);
                $('#startingDate').val(employee.StartingDate ? new Date(employee.StartingDate).toISOString().split('T')[0] : '');
                $('#leavingDate').val(employee.LeavingDate ? new Date(employee.LeavingDate).toISOString().split('T')[0] : '');
                populateDepartmentDropdown(employee.DepartmentKey ? employee.DepartmentKey.toString() : '');
                $('#employeeModal').modal('show');
            }
        }

        function populateDepartmentDropdown(selectedKey = '') {
            const departmentSelect = $('#departmentKey');
            departmentSelect.empty();
            departmentSelect.append('<option value="">Select Department</option>');
            departments.forEach(dept => {
                const isSelected = dept.DepartmentKey && selectedKey && dept.DepartmentKey.toString() === selectedKey.toString() ? 'selected' : '';
                departmentSelect.append(`<option value="${dept.DepartmentKey}" ${isSelected}>${dept.DepartmentName}</option>`);
            });
        }

               // ===== CONFIRMATION MODAL HELPER =====
        function showConfirmModal(message, onConfirm) {
            $('#confirmMessage').text(message);
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

            // Remove old event listeners
            $('#confirmBtn').off('click');

            // Add new event listener
            $('#confirmBtn').on('click', function() {
                confirmModal.hide();
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });

            confirmModal.show();
        }

        $('#employeeForm').on('submit', function (e) {
            e.preventDefault();
            const employee = {
                EmployeeKey: $('#employeeKey').val() || '00000000-0000-0000-0000-000000000000',
                EmployeeID: $('#employeeID').val(),
                LastName: $('#lastName').val(),
                FirstName: $('#firstName').val(),
                DepartmentKey: $('#departmentKey').val() || null,
                CompanyEmail: $('#companyEmail').val(),
                StartingDate: $('#startingDate').val() || null,
                LeavingDate: $('#leavingDate').val() || null
            };

            if (!employee.EmployeeID || !employee.LastName || !employee.FirstName || !employee.CompanyEmail) {
                showAlert('danger', 'Please fill in all required fields!');
                return;
            }

            const url = isEditMode ? '/Manage/Employee?handler=Update' : '/Manage/Employee?handler=Create';

            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(employee),
                headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                success: function (response) {
                    if (response.success) {
                        $('#employeeModal').modal('hide');
                        showAlert('success', response.message || (isEditMode ? 'Employee updated successfully!' : 'Employee added successfully!'));
                        loadEmployees(currentPage, searchTerm, statusFilter);
                    } else {
                        showAlert('danger', response.message || 'Error saving employee!');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', xhr.status, error);
                    showAlert('danger', isEditMode ? `Update failed: ${xhr.statusText}` : `Add failed: ${xhr.statusText}`);
                }
            });
        });

            function deleteEmployee(employeeKey, isSoftDeleted) {
            const employee = employees.find(emp => emp.EmployeeKey === employeeKey);
            const employeeName = employee ? `${employee.FirstName} ${employee.LastName}` : 'this employee';

            const confirmMessage = isSoftDeleted
                ? `This employee "${employeeName}" is already inactive.\n\nDo you want to PERMANENTLY DELETE this employee?\n\nThis action CANNOT be undone!`
                : `Are you sure you want to SOFT DELETE employee "${employeeName}"?\n\nThis will set their leaving date to today.`;

            showConfirmModal(confirmMessage, function() {
                const handler = isSoftDeleted ? 'Delete' : 'SoftDelete';

                $.ajax({
                    url: `/Manage/Employee?handler=${handler}&employeeKey=${employeeKey}`,
                    method: 'GET',
                    headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                    success: function (response) {
                        if (response && response.success) {
                            showAlert('success', response.message || (isSoftDeleted ? 'Employee permanently deleted!' : 'Employee soft deleted!'));
                            loadEmployees(currentPage, searchTerm, statusFilter);
                        } else {
                            showAlert('danger', response.message || `Error ${isSoftDeleted ? 'permanently deleting' : 'soft deleting'} employee!`);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error details:', { status: xhr.status, statusText: xhr.statusText, responseText: xhr.responseText });
                        showAlert('danger', `Error ${isSoftDeleted ? 'permanently deleting' : 'soft deleting'} employee: ${xhr.statusText || 'Unknown reason'}`);
                    }
                });
            });
        }

        function showAlert(type, message) {
            const alertDiv = $(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `);
            alertDiv.css({
                position: 'fixed',
                top: '20px',
                right: '20px',
                zIndex: 9999
            });
            $('body').append(alertDiv);
            setTimeout(() => alertDiv.alert('close'), 3000);
        }
    </script>
}