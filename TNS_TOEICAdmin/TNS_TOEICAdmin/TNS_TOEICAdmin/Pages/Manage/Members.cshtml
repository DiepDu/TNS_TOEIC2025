@page
@model TNS_TOEICAdmin.Pages.Manage.MembersModel
@{
    ViewData["Title"] = "Member Management";
}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --danger-color: #e74c3c;
        --text-color: #34495e;
        --bg-color: #f4f7f6;
        --container-bg: #ffffff;
        --shadow-color: rgba(0, 0, 0, 0.08);
    }

    #testHistoryContainer .table thead {
        position: sticky;
        top: 0;
        z-index: 10; /* Đảm bảo header nằm trên các dòng khác */
        background-color: #f8f9fa; /* Thêm màu nền để che nội dung bên dưới khi cuộn */
    }
    body {
        background-color: var(--bg-color);
        font-family: 'Poppins', sans-serif;
        color: var(--text-color);
    }

    .member-page-container {
        padding: 2rem;
    }

    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    h2 {
        font-weight: 700;
        font-size: 2rem;
        color: var(--text-color);
    }

    .actions-bar {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-wrapper {
        position: relative;
    }

        .search-wrapper .fa-search {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            color: #bdc3c7;
        }

    .search-input, .filter-select {
        border-radius: 25px;
        border: 1px solid #dfe6e9;
        background-color: var(--container-bg);
        padding: 0.6rem 1rem;
        transition: all 0.3s ease;
        min-width: 200px;
    }

    .search-input {
        padding-left: 40px;
    }

        .search-input:focus, .filter-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

    .btn-add {
        background-image: linear-gradient(45deg, var(--primary-color), #85c1e9);
        border: none;
        color: #fff;
        font-weight: 500;
        padding: 0.7rem 1.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

        .btn-add:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

    .table-container {
        max-height: 70vh;
        overflow-y: auto;
        border-radius: 15px;
        background-color: var(--container-bg);
        box-shadow: 0 8px 30px var(--shadow-color);
    }

    .styled-table {
        width: 100%;
        border-collapse: collapse;
    }

        .styled-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa;
            color: var(--text-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid #dfe6e9;
        }

            .styled-table thead th:first-child {
                border-top-left-radius: 15px;
            }

            .styled-table thead th:last-child {
                border-top-right-radius: 15px;
            }

        .styled-table tbody tr {
            transition: background-color 0.2s ease;
        }

            .styled-table tbody tr:hover {
                background-color: #f1f5f8;
            }

        .styled-table td {
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }

    .score-cell .exam-score {
        font-weight: 600;
        font-size: 1.1em;
    }

    .score-cell .target-score {
        color: #7f8c8d;
    }

    .status-badge {
        padding: 0.25em 0.6em;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .status-activated {
        background-color: #e8f5e9;
        color: #388e3c;
    }

    .status-locked {
        background-color: #ffebee;
        color: #d32f2f;
    }

    .btn-action {
        background: transparent;
        border: none;
        color: #95a5a6;
        font-size: 1.2rem;
        margin: 0 0.2rem;
        transition: all 0.2s ease;
    }

        .btn-action:hover {
            transform: scale(1.2);
        }

    .btn-edit:hover {
        color: var(--primary-color);
    }

    .btn-details:hover {
        color: var(--secondary-color);
    }

    .btn-delete:hover {
        color: var(--danger-color);
    }

    .pagination {
        margin-top: 2rem;
    }

        .pagination .page-link {
            border-radius: 50%;
            margin: 0 5px;
            color: var(--primary-color);
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .pagination .page-link:hover {
                background-color: #e9ecef;
            }

        .pagination .active .page-link {
            background-color: var(--primary-color);
            color: #fff;
        }

    /* Modal Styling */
    .modal-content {
        border-radius: 15px;
        border: none;
    }

    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
    }

    .modal-title {
        color: var(--text-color);
        font-weight: 600;
    }

    .modal-body {
        padding: 2rem;
    }

    .chart-container-modal {
        height: 300px;
    }

    .btn-save, .btn-cancel {
        font-weight: 500;
        padding: 0.7rem 1.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }

    .btn-save {
        background-image: linear-gradient(45deg, var(--secondary-color), #58d68d);
        border: none;
        color: #fff;
        box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }

        .btn-save:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

    .btn-cancel {
        background-color: #dfe6e9;
        border-color: #dfe6e9;
    }

        .btn-cancel:hover {
            background-color: #b2bec3;
        }

    /* Scrollbar */
    .table-container::-webkit-scrollbar {
        width: 8px;
    }

    .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: #bdc3c7;
        border-radius: 4px;
    }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
</style>

<div class="container-fluid member-page-container">
    <div class="header-bar">
        <h2><i class="fas fa-user-graduate me-2"></i>Member Management</h2>
        <div class="actions-bar">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control search-input" id="searchInput" placeholder="Search by ID or Name..." />
            </div>
            <select class="form-control filter-select" id="activateFilter">
                <option value="">All Statuses</option>
                <option value="1">Activated</option>
                <option value="0">Locked</option>
            </select>
            <button class="btn btn-add" onclick="showAddModal()"><i class="fas fa-plus me-1"></i>Add Member</button>
        </div>
    </div>

    <div class="table-container">
        <table class="table styled-table">
            <thead>
                <tr>
                    <th>Member ID</th>
                    <th>Member Name</th>
                    <th>Score (Exam/Target)</th>
                    <th>Ability (IRT)</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="memberTableBody"></tbody>
        </table>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberModalLabel">Add Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="memberForm">
                    <input type="hidden" id="memberKey" name="memberKey" />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="memberID" class="form-label">MemberID</label>
                            <input type="text" class="form-control" id="memberID" name="memberID" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="memberName" class="form-label">Member Name</label>
                            <input type="text" class="form-control" id="memberName" name="memberName" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" placeholder="Enter only when creating or resetting" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-control" id="gender" name="gender">
                                <option value="1">Male</option>
                                <option value="0">Female</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="yearOld" class="form-label">Age</label>
                            <input type="number" class="form-control" id="yearOld" name="yearOld" min="1" max="100" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="departmentKey" class="form-label">Department</label>
                            <select class="form-control" id="departmentKey" name="departmentKey">
                                <option value="">Not Linked</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="scoreTarget" class="form-label">Target Score</label>
                            <input type="number" class="form-control" id="scoreTarget" name="scoreTarget" min="0" max="990" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="toeicScoreExam" class="form-label">Exam Score</label>
                            <input type="number" class="form-control" id="toeicScoreExam" name="toeicScoreExam" min="0" max="990" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="irtAbility" class="form-label">IRT Ability</label>
                            <input type="number" step="0.01" class="form-control" id="irtAbility" name="irtAbility" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="activate" class="form-label">Status</label>
                            <select class="form-control" id="activate" name="activate">
                                <option value="1">Activated</option>
                                <option value="0">Locked</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-save"><i class="fas fa-save me-2"></i>Save</button>
                        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Member Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-4">
                        <h6>Personal Information</h6>
                        <p><strong>Member ID:</strong> <span id="detailMemberID"></span></p>
                        <p><strong>Name:</strong> <span id="detailMemberName"></span></p>
                        <p><strong>Gender:</strong> <span id="detailGender"></span></p>
                        <p><strong>Age:</strong> <span id="detailYearOld"></span></p>
                        <p><strong>Department:</strong> <span id="detailDepartment"></span></p>
                        <hr />
                        <h6>Performance Metrics</h6>
                        <p><strong>Target Score:</strong> <span id="detailScoreTarget"></span></p>
                        <p><strong>Exam Score:</strong> <span id="detailToeicScoreExam"></span></p>
                        <p><strong>IRT Ability:</strong> <span id="detailIrtAbility"></span></p>
                    </div>
                    <div class="col-lg-8">
                        <h6>Practice Score Analysis (by Parts)</h6>
                        <div class="chart-container-modal">
                            <canvas id="practiceScoreChart"></canvas>
                        </div>
                    </div>
                </div>

                @* --- PHẦN MÃ MỚI ĐƯỢC THÊM VÀO --- *@
                <hr class="my-4" />
                <h6>Test History & Progress Chart</h6>
                <div class="btn-group mb-3" role="group" id="historyTypeSelector">
                    <button type="button" id="fullTestHistoryBtn" class="btn btn-primary active" onclick="loadTestHistory('FullTest', this)">Full Tests</button>

                    <div class="btn-group" role="group">
                        <button id="practiceTestHistoryBtn" type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            Practice Tests
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice', this, 'Practice Tests')">All Practice</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice-1', this, 'Practice Part 1')">Part 1</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice-2', this, 'Practice Part 2')">Part 2</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice-3', this, 'Practice Part 3')">Part 3</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice-4', this, 'Practice Part 4')">Part 4</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice-5', this, 'Practice Part 5')">Part 5</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice-6', this, 'Practice Part 6')">Part 6</a></li>
                            <li><a class="dropdown-item" href="#" onclick="loadTestHistory('Practice-7', this, 'Practice Part 7')">Part 7</a></li>
                        </ul>
                    </div>
                </div>

                @* Container cho biểu đồ có thể cuộn *@
                <div class="chart-container-modal mb-3" style="height: 350px;">
                    <canvas id="historyChart"></canvas>
                </div>

                @* Container cho bảng lịch sử *@
                <div id="testHistoryContainer" class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-muted">Select a history type to view...</p>
                </div>
             
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editTestModal" tabindex="-1" aria-labelledby="editTestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTestModalLabel">Edit Test Score</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTestForm" onsubmit="event.preventDefault(); submitEditTestScore();">
                    <input type="hidden" id="editResultKey" name="editResultKey" />
                    <div class="mb-3">
                        <label for="editTestScore" class="form-label">Test Score</label>
                        <input type="number" class="form-control" id="editTestScore" name="editTestScore" min="0" max="990" required />
                        <small class="form-text text-muted">Enter total score for Full Test, or percentage for Practice Test.</small>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-save"><i class="fas fa-save me-2"></i>Save Score</button>
                        <button type="button" class="btn btn-danger" onclick="cancelTest()"><i class="fas fa-ban me-2"></i>Cancel Test</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
@section Scripts {
    <script>
        let currentHistoryType = 'FullTest';
     
        let members = [];
        let currentMemberKey = null;
        let currentPage = 1;
        const pageSize = 10;
        let searchTerm = '';
        let activateFilter = '';
        let isEditMode = false;
        let practiceScoreChart = null;
        let historyChart = null;

        $(document).ready(function () {
            loadMembers();
            Chart.register(ChartZoom);
            $('#searchInput').on('keyup', debounce(searchMembers, 500));
            $('#activateFilter').on('change', searchMembers);
        });

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function loadMembers(page = 1) {
            currentPage = page;
            searchTerm = $('#searchInput').val().trim();
            activateFilter = $('#activateFilter').val();

            let data = { page: currentPage, pageSize: pageSize, search: searchTerm, activate: activateFilter };

            $.ajax({
                url: '/Manage/Members?handler=GetMembers',
                method: 'GET',
                data: data,
                dataType: 'json',
                success: function (response) {
                    if (response.status === 'ERROR') {
                        showAlert('danger', response.message);
                        members = [];
                    } else {
                        members = Array.isArray(response.members) ? response.members : [];
                        renderMembers();
                        renderPagination(response.totalItems);
                    }
                },
                error: () => showAlert('danger', 'Failed to load member list.')
            });
        }

        function renderMembers() {
            const tbody = $('#memberTableBody');
            tbody.empty();
            if(members.length === 0) {
                tbody.append(`<tr><td colspan="7" class="text-center p-5">No members found.</td></tr>`);
                return;
            }
          members.forEach(m => {
                // THAY ĐỔI Ở ĐÂY: Sử dụng PascalCase
                const statusClass = m.Activate ? 'status-activated' : 'status-locked';
                const statusText = m.Activate ? 'Activated' : 'Locked';

                tbody.append(`
                    <tr style="animation: fadeIn 0.5s ease-out;">
                        <td><strong>${m.MemberID || 'N/A'}</strong></td>
                        <td>${m.MemberName || 'N/A'}</td>
                        <td class="score-cell">
                            <span class="exam-score">${m.ToeicScoreExam ?? 'N/A'}</span> / <span class="target-score">${m.ScoreTarget ?? 'N/A'}</span>
                        </td>
                        <td>${m.IrtAbility?.toFixed(2) ?? 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${m.LastLoginDate || 'Never'}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="showEditModal('${m.MemberKey}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-action btn-details" onclick="showDetailsModal('${m.MemberKey}')" title="Details"><i class="fas fa-info-circle"></i></button>
                            <button class="btn-action btn-delete" onclick="showDeleteModal('${m.MemberKey}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            const pagination = $('#pagination');
            pagination.empty();
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                pagination.append(`<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); loadMembers(${i});">${i}</a>
                </li>`);
            }
        }

        function searchMembers() {
            loadMembers(1);
        }

        function showDetailsModal(memberKey) {
             currentMemberKey = memberKey;
             // Hủy biểu đồ cũ trước khi mở modal mới để tránh lỗi
             if (practiceScoreChart) practiceScoreChart.destroy();
             if (historyChart) {
                 historyChart.destroy();
                 historyChart = null;
             }

             $.ajax({
                 url: `/Manage/Members?handler=GetMemberDetails&memberKey=${memberKey}`,
                 method: 'GET',
                 success: function (member) {
                     // THAY ĐỔI Ở ĐÂY: Sử dụng PascalCase cho tất cả các thuộc tính
                     $('#detailsModalLabel').text(`Details for ${member.MemberName}`);
                     $('#detailMemberID').text(member.MemberID || 'N/A');
                     $('#detailMemberName').text(member.MemberName || 'N/A');
                     $('#detailGender').text(member.Gender === 1 ? 'Male' : 'Female');
                     $('#detailYearOld').text(member.YearOld || 'N/A');
                     $('#detailDepartment').text(member.DepartmentName || 'Not Linked');
                     $('#detailScoreTarget').text(member.ScoreTarget ?? 'N/A');
                     $('#detailToeicScoreExam').text(member.ToeicScoreExam ?? 'N/A');
                     $('#detailIrtAbility').text(member.IrtAbility?.toFixed(2) ?? 'N/A');

                     const practiceScores = [
                         member.PracticeScore_Part1, member.PracticeScore_Part2, member.PracticeScore_Part3,
                         member.PracticeScore_Part4, member.PracticeScore_Part5, member.PracticeScore_Part6,
                         member.PracticeScore_Part7
                     ];
                     renderPracticeScoreChart(practiceScores);

                            loadTestHistory('FullTest', document.getElementById('fullTestHistoryBtn'));
        $('#detailsModal').modal('show');
                         },
                         error: () => showAlert('danger', 'Failed to load member details.')
                     });
        }
        function loadTestHistory(type, element, buttonText = null) {
               event.preventDefault();
               if (!currentMemberKey) return;
               currentHistoryType = type; // Lưu lại type đang xem

               // Cập nhật giao diện nút bấm
               const fullTestBtn = $('#fullTestHistoryBtn');
               const practiceBtn = $('#practiceTestHistoryBtn');

               if (type.startsWith('Practice')) {
                   fullTestBtn.removeClass('active btn-primary').addClass('btn-outline-primary');
                   practiceBtn.removeClass('btn-outline-primary').addClass('active btn-primary');
                   if (buttonText) {
                       practiceBtn.text(buttonText);
                   }
               } else { // FullTest
                   practiceBtn.removeClass('active btn-primary').addClass('btn-outline-primary').text('Practice Tests');
                   fullTestBtn.removeClass('btn-outline-primary').addClass('active btn-primary');
               }

              $.ajax({
                  url: `/Manage/Members?handler=GetTestScoreHistory&memberKey=${currentMemberKey}&type=${type}`,
                  method: 'GET',
                  success: function(historyData) {
                      renderHistoryTable(historyData, type);

                      renderHistoryChart(historyData, type); // Gọi hàm vẽ biểu đồ mới
                  },
                  error: function() {
                      container.html('<p class="text-danger text-center p-3">Failed to load history.</p>');
                      if (historyChart) historyChart.destroy(); // Xóa biểu đồ nếu lỗi
                  }
              });
         }

            function renderHistoryTable(data, type) {
            const container = $('#testHistoryContainer');
            container.empty();

            if (!data || data.length === 0) {
                container.html('<p class="text-muted text-center p-3">No history found.</p>');
                return;
            }

            // Hàm helper để tạo badge trạng thái
            const getStatusBadge = (status) => {
                switch (status) {
                    case 99: return '<span class="badge bg-danger">Cancelled</span>';
                    case 2: return '<span class="badge bg-warning text-dark">Edited</span>';
                    case 1: return '<span class="badge bg-success">Completed</span>';
                    default: return '<span class="badge bg-secondary">Unknown</span>';
                }
            };

            let table = '<table class="table table-sm table-striped table-hover"><thead><tr>';
            if (type.startsWith('FullTest')) {
                table += '<th>Test Name</th><th>Total</th><th>Listen</th><th>Read</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                data.forEach(item => {
                    const startTime = new Date(item.StartTime).toLocaleString('vi-VN');
                    const statusBadge = getStatusBadge(item.Status);
                    const isCancelled = item.Status === 99;

                    table += `<tr>
                        <td>${item.TestName || 'N/A'}</td>
                        <td><strong>${item.TestScore ?? 'N/A'}</strong></td>
                        <td>${item.ListeningScore ?? 'N/A'}</td>
                        <td>${item.ReadingScore ?? 'N/A'}</td>
                        <td>${startTime}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewTestResult('${item.TestKey}', '${item.ResultKey}')" title="Review"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-warning" onclick="showEditTestModal('${item.ResultKey}', ${item.TestScore ?? 0})" title="Edit Score" ${isCancelled ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
                });
            } else { // Practice
                table += '<th>Part Name</th><th>Score (%)</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                data.forEach(item => {
                    const startTime = new Date(item.StartTime).toLocaleString('vi-VN');
                    const statusBadge = getStatusBadge(item.Status);
                    const isCancelled = item.Status === 99;

                    table += `<tr>
                        <td>${item.TestName || 'N/A'}</td>
                        <td><strong>${item.PracticeScore ?? 'N/A'}%</strong></td>
                        <td>${startTime}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewTestResult('${item.TestKey}', '${item.ResultKey}')" title="Review"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-warning" onclick="showEditTestModal('${item.ResultKey}', ${item.PracticeScore ?? 0})" title="Edit Score" ${isCancelled ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
                });
            }
            table += '</tbody></table>';
            container.html(table);
        }
          function showEditTestModal(resultKey, currentScore) {
            $('#editResultKey').val(resultKey);
            $('#editTestScore').val(currentScore);
            $('#editTestModal').modal('show');
        }

        $('#editTestForm').on('submit', function (e) {
            e.preventDefault();
            const resultKey = $('#editResultKey').val();
            const newScore = parseInt($('#editTestScore').val());

            $.ajax({
                url: '/Manage/Members?handler=UpdateTestScore',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ResultKey: resultKey, TestScore: newScore }),
                headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                success: function (response) {
                    $('#editTestModal').modal('hide');
                    showAlert('success', response.message);
                    loadTestHistory(currentHistoryType); // Tải lại lịch sử hiện tại
                },
                error: (xhr) => showAlert('danger', xhr.responseJSON?.message || 'Failed to update score.')
            });
        });

        function cancelTest() {
            const resultKey = $('#editResultKey').val();
            if (confirm('Are you sure you want to cancel this test result? This action marks the test as cancelled.')) {
                $.ajax({
                    url: '/Manage/Members?handler=CancelTest',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ ResultKey: resultKey }),
                    headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                    success: function (response) {
                        $('#editTestModal').modal('hide');
                        showAlert('success', response.message);
                        loadTestHistory(currentHistoryType); // Tải lại lịch sử hiện tại
                    },
                    error: (xhr) => showAlert('danger', xhr.responseJSON?.message || 'Failed to cancel test.')
                });
            }
        }
           function renderHistoryChart(data, type) {
              const ctx = document.getElementById('historyChart').getContext('2d');
              if (historyChart) {
                  historyChart.destroy();
              }

              if (!data || data.length === 0) {
                  return;
                  // Không vẽ gì nếu không có dữ liệu
              }

              const labels = data.map(item => new Date(item.StartTime).toLocaleDateString('vi-VN'));
              const scores = (type === 'FullTest') ? data.map(item => item.TestScore) : data.map(item => item.PracticeScore);
              const chartLabel = (type === 'FullTest') ? 'Total Score' : 'Practice Score (%)';
              const yMax = (type === 'FullTest') ?
              990 : 100;

              historyChart = new Chart(ctx, {
                  type: 'bar',
                  data: {
                      labels: labels,
                      datasets: [

                         {
                              label: chartLabel,
                              data: scores,
                              backgroundColor: 'rgba(52, 152, 219, 0.6)',

                              borderColor: 'rgba(52, 152, 219, 1)',
                              borderWidth: 1,
                              borderRadius: 5,

                              order: 2 // Vẽ cột phía sau
                          },
                          {
                              type: 'line',

                              label: 'Progress Trend',
                              data: scores,
                              borderColor: 'rgba(231, 76, 60, 0.8)',

                              backgroundColor: 'rgba(231, 76, 60, 0.2)',
                              fill: false,
                              tension: 0.1,

                              order: 1 // Vẽ đường phía trên
                          }
                      ]
                  },
                  options: {

                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                          y: {

                              beginAtZero: true,
                              max: yMax
                          }
                      },

                      plugins: {
                          legend: {
                              position: 'top',
                          },

                          title: {
                              display: true,
                              text: 'Student Progress Over Time (Scroll/Pinch to Zoom & Pan)'
                          },

                          zoom: {
                              pan: {
                                  enabled: true,

                                  mode: 'x' // Chỉ cho phép cuộn ngang
                              },
                              zoom: {

                                  wheel: { enabled: true },
                                  pinch: { enabled: true },
                                  mode: 'x', // Chỉ cho phép zoom theo chiều ngang

                              }
                          }
                      }
                  }
              });
          }
        function viewTestResult(testKey, resultKey) {
              // URL này cần được điều chỉnh cho phù hợp với cấu trúc project của bạn
              const url = `/Test/ResultTest?testKey=${testKey}&resultKey=${resultKey}`;
              window.open(url, '_blank');
          }
        function renderPracticeScoreChart(scores) {
            const ctx = document.getElementById('practiceScoreChart').getContext('2d');
            if (practiceScoreChart) {
                practiceScoreChart.destroy();
            }
            practiceScoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Part 1', 'Part 2', 'Part 3', 'Part 4', 'Part 5', 'Part 6', 'Part 7'],
                    datasets: [{
                        label: 'Practice Score (%)',
                        data: scores,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: value => value + '%' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function showAddModal() {
            isEditMode = false;
            $('#memberModalLabel').text('Add Member');
            $('#memberForm')[0].reset();
            $('#memberKey').val('');
            $('#password').prop('required', true);
            populateDepartmentDropdown();
            $('#memberModal').modal('show');
        }

        function showEditModal(memberKey) {
                 $.ajax({
                    url: `/Manage/Members?handler=GetMemberDetails&memberKey=${memberKey}`,
                    method: 'GET',
                    success: function (memberDetails) {

                        isEditMode = true;
                        // THAY ĐỔI Ở ĐÂY: Sử dụng PascalCase
                        $('#memberModalLabel').text('Edit Member');
                        $('#memberKey').val(memberDetails.MemberKey);
                        $('#memberID').val(memberDetails.MemberID);
                        $('#memberName').val(memberDetails.MemberName);
                        $('#password').val('').prop('required', false).attr('placeholder', 'Leave blank to keep current password');
                        $('#gender').val(memberDetails.Gender);
                        $('#yearOld').val(memberDetails.YearOld);
                        $('#scoreTarget').val(memberDetails.ScoreTarget);
                        $('#toeicScoreExam').val(memberDetails.ToeicScoreExam);
                        $('#irtAbility').val(memberDetails.IrtAbility);
                        $('#activate').val(memberDetails.Activate ? '1' : '0');
                        populateDepartmentDropdown(memberDetails.DepartmentKey);
                        $('#memberModal').modal('show');
                    },
                    error: () => showAlert('danger', 'Failed to load member details for editing.')
                });
            }

        function populateDepartmentDropdown(selectedKey = '') {
             $.ajax({
                 url: '/Manage/Members?handler=GetDepartments',
                 method: 'GET',
                 success: function (data) {
                     const deptSelect =
                     $('#departmentKey');
                     deptSelect.empty().append('<option value="">Not Linked</option>');
                     if (Array.isArray(data)) {
                         data.forEach(dept => {
                             // THAY ĐỔI Ở ĐÂY: Sử dụng PascalCase
                             if (dept && dept.DepartmentKey && dept.DepartmentName) {
                                 const isSelected = dept.DepartmentKey === selectedKey;
                                 deptSelect.append(new Option(dept.DepartmentName, dept.DepartmentKey, false, isSelected));

                              }
                         });
                         if(selectedKey){
                             deptSelect.val(selectedKey);

                          }
                     }
                 }
             });
         }

        $('#memberForm').on('submit', function (e) {
                e.preventDefault();
                // THAY ĐỔI Ở ĐÂY: Gửi dữ liệu đi với key là PascalCase
                const formData = {
                    MemberKey: $('#memberKey').val() || '00000000-0000-0000-0000-000000000000',
                    MemberID: $('#memberID').val(),
                    MemberName: $('#memberName').val(),
                    Password: $('#password').val() || null,
                    Gender: parseInt($('#gender').val()),
                    YearOld: parseInt($('#yearOld').val()),
                    DepartmentKey: $('#departmentKey').val() || null,
                    Activate: $('#activate').val() === '1',
                    ScoreTarget: $('#scoreTarget').val()
                    ? parseInt($('#scoreTarget').val()) : null,
                    ToeicScoreExam: $('#toeicScoreExam').val() ? parseInt($('#toeicScoreExam').val()) : null,
                    IrtAbility: $('#irtAbility').val() ? parseFloat($('#irtAbility').val()) : null,
                };

                const url = isEditMode ? '/Manage/Members?handler=Update' : '/Manage/Members?handler=Create';
                $.ajax({
                    url: url,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },

                    success: function (response) {
                        $('#memberModal').modal('hide');
                        showAlert('success', response.message);
                        loadMembers(isEditMode ? currentPage : 1);
                    },

                    error: function (xhr) {
                         showAlert('danger', xhr.responseJSON?.message || (isEditMode ? 'Update failed.' : 'Add failed.'));
                    }
                });
            });

        function showDeleteModal(memberKey) {
            currentMemberKey = memberKey;
            if (confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
                deleteMember(currentMemberKey);
            }
        }

        function deleteMember(memberKey) {
            $.ajax({
                url: `/Manage/Members?handler=Delete&memberKey=${memberKey}`,
                method: 'GET',
                headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                success: function () {
                    showAlert('success', 'Member deleted successfully!');
                    loadMembers(1);
                },
                error: () => showAlert('danger', 'Failed to delete member.')
            });
        }

        function showAlert(type, message) {
               // Can be replaced with a nicer toast notification library like Toastr
               const alertContainer = document.createElement('div');
               alertContainer.innerHTML = `
                   <div style="position: fixed; top: 20px; right: 20px; z-index: 1055;"
                   class="alert alert-${type} alert-dismissible fade show" role="alert">
                       ${message}
                       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                   </div>
               `;
               document.body.appendChild(alertContainer);
               setTimeout(() => {
                   $(alertContainer).find('.alert').alert('close');
               }, 3000);
           }
    </script>
}

