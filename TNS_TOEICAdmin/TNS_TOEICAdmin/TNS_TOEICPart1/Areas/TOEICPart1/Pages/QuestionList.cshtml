@page
@model TNS_TOEICPart1.Areas.TOEICPart1.Pages.QuestionListModel
@{
    Layout = "_Layout";
}

<style>
    .tns-field-name {
        width: 140px;
    }

    .centered-cell {
        text-align: center;
        vertical-align: middle;
    }

    .centered-image {
        display: block;
        margin: auto;
        max-width: 100%;
        height: auto;
    }

    .audio-player {
        display: block;
        margin: auto;
    }

    .answer-label {
        display: inline-block;
        margin: 0 5px;
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
    }
</style>
<link href="~/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/lib/datatables/css/dataTables.min.css" rel="stylesheet" type="text/css" />

<div style="width:100%; margin:-20px 0 0 -20px">
    <div style="padding:5px; font-weight:bold; font-size:13px">
        <a href="~/Index" style="text-decoration:none; color:#4c4c4c">Home</a>
        <span class="uil-angle-double-right"></span>
        <a href="~/Index" style="text-decoration:none; color:#4c4c4c">TOEIC</a>
        <span class="uil-angle-double-right"></span>
        <span style="color:maroon">PART 1</span>
    </div>
</div>
<div class="row">
    <div class="col-12 text-center text-primary" style="font-size:26px; font-weight:bold">
        QUESTION PART 1
    </div>
</div>
<div class="row mb-2">
    <div class="col-md-10">
        <div>
            <div class="input-group">
                <input id="txtSearch" type="text" class="form-control w-auto" placeholder="Search" aria-label="Search" aria-describedby="button-addon2">
                <input id="txtLevel" type="text" class="form-control" placeholder="Level" aria-label="Level" aria-describedby="button-addon2">
                <input id="txtFromDate" class="form-control" type="date">
                <input id="txtToDate" class="form-control" type="date">
                <button class="btn btn-primary" onclick="btn_Search_Click()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div style="color:maroon; font-weight:bold; padding-left:10px">
            <div id="Info_View"></div>
        </div>
    </div>
    <div class="col-md-2 text-end">
        <a href="/TOEICPart1/Question" class="btn btn-success" role="button" aria-pressed="true"> <i class="uil-file-blank"></i>Add New</a>
    </div>
</div>

<div class="row">
    <table id="LV_Datatable" class="table table-striped table-bordered" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
        <thead>
            <tr>
                <th class="text-center align-middle text-light bg-primary" style="width:80px">No</th>
                <th class="text-center align-middle text-light bg-primary">Question</th>
                <th class="text-center align-middle text-light bg-primary" style="width:120px">Audio</th>
                <th class="text-center align-middle text-light bg-primary">Image</th>
                <th class="text-center align-middle text-light bg-primary" style="width:90px">Level</th>
                <th class="text-center align-middle text-light bg-primary" style="width:120px">Access</th>
                <th class="text-center align-middle text-light bg-primary" style="width:100px">Answer</th>
            </tr>
        </thead>
        <tbody id="LV_DataBody">
        </tbody>
    </table>
    <div class="row">
        <div class="col-12 text-end" style="cursor:pointer" onclick="LV_LoadData_More()">More...</div>
    </div>
    <div id="LV_Waiting" style="display:none">
        <div class='text-center'>
            <div class='spinner-border text-primary m-5' role='status'>
                <span class='sr-only'>Loading...</span>
            </div>
        </div>
    </div>
</div>

<div>
    <div style="cursor:pointer" onclick="Log_Show()">
        <i class="uil-apple"></i>
    </div>
    <div id="Log_ViewData" class="row" style="display:none; padding:20px;">
    </div>
</div>

@* Xóa các script trực tiếp trong <body> vì đã include trong _Layout.cshtml *@
@* <script src="~/lib/jquery/jquery.min.js"></script> *@
@* <script src="~/lib/bootstrap/js/bootstrap.min.js"></script> *@
@* <script src="~/lib/datatables/js/dataTables.min.js"></script> *@

@section Scripts {
    <script>
        $(document).ready(function () {
            LV_LoadData_Ajax();
        });

        function Log_Show() {
            $("#Log_ViewData").css("display", "");
        }

        var _DataView;
        var _PageSize = 25;
        var _PageNumber = 1;

        function btn_Search_Click() {
            $("#LV_DataBody").html("");
            _PageNumber = 1;
            LV_LoadData_Ajax();
        }

        function LV_LoadData_Ajax() {
            $("#LV_Waiting").css("display", "");
            var zSearch = $("#txtSearch").val();
            var zFromDate = $('#txtFromDate').val();
            var zToDate = $('#txtToDate').val();
            var zLevel = $('#txtLevel').val();
            if (zLevel.length == 0)
                zLevel = 0;
            var zDataRequest = {
                "Search": zSearch, "Level": zLevel,
                "fromDate": zFromDate, "toDate": zToDate,
                "pageSize": _PageSize, "pageNumber": _PageNumber
            };

            $.ajax({
                type: 'POST',
                url: "/TOEICPart1/QuestionList?handler=LoadData",
                data: JSON.stringify(zDataRequest),
                contentType: "application/json",
                dataType: "json",
            })
                .done(function (dataResponse) {
                    _DataView = dataResponse;
                    LV_DisplayData();
                    $("#LV_Waiting").css("display", "none");
                    $("#Info_View").html("Total: " + dataResponse.length + " items");
                })
                .fail(function (error) {
                    alert('Error : ' + error.responseText);
                });
        }

        function LV_DisplayData() {
            var zContent = "";
            var n = 0;
            if (_DataView != null) {
                n = _DataView.length;
            }
            var zNo = 1 + (_PageNumber - 1) * _PageSize;
            for (i = 0; i < n; i++) {
                zContent += "       <tr >";
                zContent += "           <td class='centered-cell'>";
                zContent += "               <div> " + zNo + " </div>";
                zContent += "           </td>";
                zContent += "           <td class='centered-cell' onclick='EditRecord(\"" + _DataView[i].QuestionKey + "\")' style='cursor:pointer'>" + _DataView[i].QuestionText + "</td>";
                zContent += "           <td class='centered-cell'><audio controls class='audio-player'><source src='" + _DataView[i].QuestionVoice + "' type='audio/mp3'></audio></td>";
                zContent += "           <td class='centered-cell'><img src='" + _DataView[i].QuestionImage + "' class='centered-image' width='100' height='100' /></td>";
                zContent += "           <td class='centered-cell'>" + _DataView[i].SkillLevel + "</td>";
                zContent += "           <td class='centered-cell'>" + _DataView[i].AmountAccess + "</td>";
                zContent += "           <td class='centered-cell'> <button type='button' class='btn btn-warning' onclick='showAnswers(\"" + _DataView[i].QuestionKey + "\")'>View Answers</button></td>";
                zContent += "       </tr>";
                zNo++;
            }
            var zDataCurrent = $("#LV_DataBody").html();
            $("#LV_DataBody").html(zDataCurrent + zContent);
        }

        function EditRecord(QuestionKey) {
            zUrl = "/TOEICPart1/Question?Key=" + QuestionKey;
            window.location = zUrl;
        }

        function btnAnswer_Click(QuestionKey) {
            zUrl = "/TOEICPart1/AnswerList?Key=" + QuestionKey;
            window.location = zUrl;
        }

        function LV_LoadData_More() {
            _PageNumber++;
            LV_LoadData_Ajax();
        }

        function showAnswers(questionKey) {
            $.ajax({
                type: 'GET',
                url: "/api/toeic/part1/answers?questionKey=" + questionKey,
                contentType: "application/json",
                dataType: "json",
            })
                .done(function (dataResponse) {
                    var answersHtml = "<div class='answer-container'><h4>Answers:</h4>";
                    dataResponse.forEach(function (answer, index) {
                        answersHtml += "<div class='answer-label'>Option " + String.fromCharCode(65 + index) + ": (Empty - Listen to Audio)</div>";
                    });
                    answersHtml += "</div>";
                    $("#Log_ViewData").html(answersHtml).css("display", "");
                })
                .fail(function (error) {
                    alert('Error loading answers: ' + error.responseText);
                });
        }
    </script>
}