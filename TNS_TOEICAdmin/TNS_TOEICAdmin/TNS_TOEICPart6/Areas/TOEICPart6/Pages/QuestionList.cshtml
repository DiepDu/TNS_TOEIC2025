@page
@model TNS_TOEICPart6.Areas.TOEICPart6.Pages.QuestionListModel
@{
    Layout = "_Layout";
}

<link href="~/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/lib/datatables/css/dataTables.min.css" rel="stylesheet" type="text/css" />

<style>
    /* ===== ROOT VARIABLES ===== */
    :root {
        --primary-blue: #3498db;
        --primary-dark: #2980b9;
        --success-green: #27ae60;
        --danger-red: #e74c3c;
        --warning-yellow: #f39c12;
        --text-dark: #2c3e50;
        --bg-white: #ffffff;
        --bg-light-blue: #f0f8ff;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
        --radius-sm: 8px;
        --radius-md: 12px;
    }

    /* ===== BREADCRUMB ===== */
    .breadcrumb-custom {
        background: var(--bg-white);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
    }

        .breadcrumb-custom a {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

            .breadcrumb-custom a:hover {
                color: var(--primary-blue);
            }

        .breadcrumb-custom .current {
            color: var(--danger-red);
            font-weight: 600;
        }

    /* ===== PAGE TITLE ===== */
    .page-title-container {
        text-align: center;
        margin: 1rem 0;
        padding: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
    }

    .page-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #ffffff;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

        .page-title i {
            margin-right: 0.5rem;
            font-size: 1.8rem;
        }

    /* ===== CONTROLS CONTAINER ===== */
    .controls-container {
        background: var(--bg-white);
        padding: 1rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1rem;
    }

    .input-group .form-control {
        border: 2px solid #e0e0e0;
        border-radius: var(--radius-sm);
        padding: 0.6rem 1rem;
        transition: all 0.3s ease;
    }

        .input-group .form-control:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

    .info-view {
        color: var(--danger-red);
        font-weight: 600;
        font-size: 0.95rem;
        margin-top: 0;
        padding-left: 0.5rem;
    }

    /* ===== CIRCULAR BUTTONS ===== */
    .btn-circular {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
        font-size: 1.3rem;
        color: #ffffff;
        margin-left: 0.5rem;
        flex-shrink: 0;
        text-decoration: none !important;
    }

    .btn-add {
        background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%);
    }

        .btn-add:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
            text-decoration: none !important;
        }

    /* ===== TABLE CONTAINER ===== */
    .table-container {
        background: var(--bg-white);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .table-wrapper {
        max-height: 600px;
        overflow-y: auto;
        position: relative;
    }

        .table-wrapper::-webkit-scrollbar {
            width: 10px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #F0F8FF 0%, #E8F4F9 100%);
            border-radius: 10px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #3498DB 0%, #2980B9 100%);
            border-radius: 10px;
            border: 2px solid #F0F8FF;
        }

            .table-wrapper::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #2980B9 0%, #1E5A8E 100%);
            }

    /* ===== TABLE STYLING ===== */
    #LV_Datatable {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 0;
    }

        #LV_Datatable thead th {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            padding: 1rem 0.75rem;
            text-align: center;
            vertical-align: middle;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 0.5px;
        }

        #LV_Datatable tbody tr {
            background-color: #ffffff;
            transition: all 0.25s ease;
        }

            #LV_Datatable tbody tr:nth-of-type(even) {
                background-color: var(--bg-light-blue);
            }

            #LV_Datatable tbody tr:hover {
                background: linear-gradient(90deg, #E8F4FD 0%, #D1E7FA 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            }

        /* ===== TABLE CELLS ===== */
        #LV_Datatable tbody td {
            padding: 0 !important;
            border: 1px solid #e9ecef;
            vertical-align: middle !important;
            text-align: center;
            transition: all 0.3s ease;
            background-color: transparent;
            height: 250px !important;
        }

            #LV_Datatable tbody td > div {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 250px;
                padding: 1rem 0.75rem;
                line-height: 1.2;
            }

            /* ===== TEXT COLUMN ===== */
            #LV_Datatable tbody td:nth-child(2) > div {
                justify-content: flex-start;
                text-align: left;
                display: block;
                overflow: hidden;
                position: relative;
            }

    /* ===== TEXT CELL WRAPPER ===== */
    .text-cell-wrapper {
        position: relative;
        cursor: pointer;
        height: 100%;
        display: block;
    }

    /* ===== VISIBLE TEXT - TRUNCATED ===== */
    .text-visible {
        display: -webkit-box;
        -webkit-line-clamp: 10;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        max-height: 220px;
        line-height: 1.4;
        cursor: pointer;
        font-weight: 500;
        color: #2c3e50;
    }

        .text-visible:hover {
            color: var(--primary-blue);
        }

    /* ===== FULL TEXT - HIDDEN FOR SEARCH ===== */
    .text-full {
        position: absolute;
        left: -9999px;
        opacity: 0;
        pointer-events: none;
        visibility: hidden;
    }

    /* ===== COLUMN SPECIFIC STYLES ===== */
    #LV_Datatable tbody td:nth-child(1) > div strong {
        font-weight: 700;
        color: #667eea;
        font-size: 0.95rem;
    }

    #LV_Datatable tbody td:nth-child(3) > div {
        font-weight: 600;
        color: var(--danger-red);
    }

    #LV_Datatable tbody td:nth-child(4) > div {
        color: #7f8c8d;
        font-weight: 500;
    }

    /* ===== CENTERED TOOLTIP STYLING ===== */
    .custom-tooltip-centered {
        position: fixed !important;
        z-index: 99999 !important;
        pointer-events: auto !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
    }

        .custom-tooltip-centered .tooltip-inner {
            max-width: 700px !important;
            min-width: 500px;
            max-height: 70vh;
            overflow-y: auto !important;
            overflow-x: hidden;
            padding: 2rem 2.5rem;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: left;
            font-size: 1rem;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
            animation: tooltipFadeIn 0.3s ease-out;
            cursor: default;
            pointer-events: auto !important;
        }

    @@keyframes tooltipFadeIn {
        from

    {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }

    }

    /* ===== SCROLLBAR STYLING ===== */
    .custom-tooltip-centered .tooltip-inner::-webkit-scrollbar {
        width: 12px !important;
    }

    .custom-tooltip-centered .tooltip-inner::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        margin: 4px 0;
    }

    .custom-tooltip-centered .tooltip-inner::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 6px;
        border: 2px solid rgba(44, 62, 80, 0.5);
    }

        .custom-tooltip-centered .tooltip-inner::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.7);
        }

    /* ===== HIDE ARROW ===== */
    .custom-tooltip-centered .tooltip-arrow {
        display: none !important;
    }

    /* ===== TEXT SELECTION ===== */
    .custom-tooltip-centered .tooltip-inner::selection {
        background: rgba(255, 255, 255, 0.3);
        color: inherit;
    }

    /* ===== BACKDROP ===== */
    .tooltip-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.4);
        z-index: 99998;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        display: none;
    }

        .tooltip-backdrop.show {
            opacity: 1;
            display: block;
        }

    /* ===== BUTTONS IN TABLE ===== */
    .btn-questionsublist {
        background: linear-gradient(135deg, var(--warning-yellow) 0%, #e67e22 100%);
        color: #ffffff;
        border: none;
        padding: 0.45rem 0.9rem;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }

        .btn-questionsublist:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

    .btn-toggle-publish {
        padding: 0.45rem 0.9rem;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 60px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        box-shadow: var(--shadow-sm);
    }

    .btn-on {
        background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%);
        color: white;
    }

        .btn-on:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            transform: scale(1.05);
        }

    .btn-off {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        color: white;
    }

        .btn-off:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #566573 100%);
            transform: scale(1.05);
        }

    /* ===== PAGINATION ===== */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        background: var(--bg-white);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1rem;
    }

    .pagination {
        display: flex;
        gap: 0.5rem;
        list-style: none;
        margin: 0;
        padding: 0;
    }

        .pagination .page-link {
            border-radius: 50% !important;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            background: #ffffff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

            .pagination .page-link:hover {
                background: var(--primary-blue);
                color: #ffffff;
                transform: translateY(-2px);
                box-shadow: var(--shadow-sm);
            }

        .pagination .page-item.active .page-link {
            background: var(--primary-blue);
            color: #ffffff;
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .pagination .page-item.disabled .page-link {
            color: #adb5bd;
            border-color: #e9ecef;
            cursor: not-allowed;
            background: #f8f9fa;
        }

    /* ===== LOADING SPINNER ===== */
    #LV_Waiting {
        text-align: center;
        padding: 3rem;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }

    /* ===== MODAL STYLING ===== */
    .modal-content {
        border-radius: var(--radius-md);
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: var(--radius-md);
        border-top-right-radius: var(--radius-md);
    }

        .modal-header.bg-warning {
            background: linear-gradient(135deg, var(--warning-yellow) 0%, #e67e22 100%) !important;
        }

        .modal-header.bg-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%) !important;
        }

        .modal-header.bg-danger {
            background: linear-gradient(135deg, var(--danger-red) 0%, #c0392b 100%) !important;
        }

    .btn-close-white {
        filter: brightness(0) invert(1);
    }

    /* ===== RESPONSIVE ===== */
    @@media (max-width: 768px) {
        .page-title

    {
        font-size: 1.4rem;
    }

    .btn-circular {
        width: 38px;
        height: 38px;
        font-size: 1.1rem;
    }

    #LV_Datatable thead th {
        font-size: 0.75rem;
        padding: 0.75rem 0.5rem;
    }

    #LV_Datatable tbody td {
        height: 200px !important;
    }

        #LV_Datatable tbody td > div {
            height: 200px;
        }

    .text-visible {
        -webkit-line-clamp: 8;
        max-height: 176px;
    }

    .custom-tooltip-centered .tooltip-inner {
        max-width: 90vw !important;
        min-width: 85vw;
        max-height: 80vh;
        padding: 1rem 1.25rem;
        font-size: 0.9rem;
    }

        .custom-tooltip-centered .tooltip-inner::-webkit-scrollbar {
            width: 10px !important;
        }

    }
</style>

<!-- Breadcrumb -->
<div class="breadcrumb-custom">
    <a href="~/Index"><i class="fas fa-home me-1"></i>Home</a>
    <span class="mx-2">›</span>
    <a href="~/Index">TOEIC</a>
    <span class="mx-2">›</span>
    <span class="current">PART 6</span>
</div>

<!-- Page Title -->
<div class="page-title-container">
    <h1 class="page-title">
        <i class="fas fa-file-alt"></i>
        TOEIC Part 6 - Text Completion
    </h1>
</div>

<!-- Controls Section -->
<div class="controls-container">
    <div class="row align-items-start">
        <div class="col-lg-9">
            <div class="input-group">
                <input id="txtSearch" type="text" class="form-control" placeholder="Search passages..." aria-label="Search">
                <input id="txtLevel" type="text" class="form-control" placeholder="Level" aria-label="Level" style="max-width: 100px;">
                <input id="txtFromDate" class="form-control" type="date" style="max-width: 140px;">
                <input id="txtToDate" class="form-control" type="date" style="max-width: 140px;">
                <select class="form-control" id="statusFilter" name="statusFilter" style="max-width: 140px;">
                    <option value="">All Status</option>
                    <option value="Using" selected>Using</option>
                    <option value="Unpublished">Unpublished</option>
                    <option value="Deleted">Deleted</option>
                </select>
            </div>
        </div>
        <div class="col-lg-3 text-end d-flex justify-content-end align-items-start">
            <a href="/TOEICPart6/Question?source=QuestionList" class="btn-circular btn-add" title="Add New Passage" onclick="savePageState()">
                <i class="fas fa-plus"></i>
            </a>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-12">
            <div class="info-view" id="Info_View"></div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmModalBtn">
                    <i class="fas fa-check me-2"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="alertModalHeader">
                <h5 class="modal-title" id="alertModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Notification
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="alertModalBody">
                Message
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>OK
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Table Section -->
<div class="table-container">
    <div class="table-wrapper">
        <table id="LV_Datatable">
            <thead>
                <tr>
                    <th style="width:60px">No</th>
                    <th style="width:auto">PASSAGE TEXT</th>
                    <th style="width:70px">Level</th>
                    <th style="width:80px">Access</th>
                    <th style="width:130px">Sub Questions</th>
                    <th style="width:80px">Status</th>
                </tr>
            </thead>
            <tbody id="LV_DataBody"></tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="pagination-container">
    <nav aria-label="Page navigation">
        <ul class="pagination" id="pagination"></ul>
    </nav>
</div>

<!-- Loading Spinner -->
<div id="LV_Waiting" style="display:none">
    <div class='spinner-border text-primary' role='status'>
        <span class='visually-hidden'>Loading...</span>
    </div>
</div>

<!-- Tooltip Backdrop -->
<div class="tooltip-backdrop" id="tooltipBackdrop"></div>

@section Scripts {
    <script>
        let _DataView;
        let _PageSize = 10;
        let _PageNumber = 1;
        let _TotalItems = 0;
        let _SearchTimeout;
        let _CurrentTooltip = null;

        $(document).ready(function () {
            restorePageState();

            $('#txtSearch, #txtLevel, #txtFromDate, #txtToDate, #statusFilter').on('input change', function() {
                clearTimeout(_SearchTimeout);
                _SearchTimeout = setTimeout(function() {
                    _PageNumber = 1;
                    LV_LoadData_Ajax();
                }, 400);
            });

            $('.table-wrapper').on('scroll', function() {
                if (sessionStorage.getItem('part6QuestionListState')) {
                    const state = JSON.parse(sessionStorage.getItem('part6QuestionListState'));
                    state.tableScrollPosition = $('.table-wrapper').scrollTop();
                    sessionStorage.setItem('part6QuestionListState', JSON.stringify(state));
                }
            });

            $(window).on('scroll', function() {
                if (sessionStorage.getItem('part6QuestionListState')) {
                    const state = JSON.parse(sessionStorage.getItem('part6QuestionListState'));
                    state.pageScrollPosition = $(window).scrollTop();
                    sessionStorage.setItem('part6QuestionListState', JSON.stringify(state));
                }
            });

            // Close tooltip when click on backdrop
            $('#tooltipBackdrop').on('click', function() {
                hideAllTooltips();
            });
        });

        function savePageState() {
            const state = {
                pageNumber: _PageNumber,
                search: $('#txtSearch').val(),
                level: $('#txtLevel').val(),
                fromDate: $('#txtFromDate').val(),
                toDate: $('#txtToDate').val(),
                statusFilter: $('#statusFilter').val(),
                tableScrollPosition: $('.table-wrapper').scrollTop(),
                pageScrollPosition: $(window).scrollTop()
            };
            sessionStorage.setItem('part6QuestionListState', JSON.stringify(state));
        }

        function restorePageState() {
            const savedState = sessionStorage.getItem('part6QuestionListState');
            if (savedState) {
                const state = JSON.parse(savedState);
                $('#txtSearch').val(state.search || '');
                $('#txtLevel').val(state.level || '');
                $('#txtFromDate').val(state.fromDate || '');
                $('#txtToDate').val(state.toDate || '');
                $('#statusFilter').val(state.statusFilter || 'Using');
                _PageNumber = state.pageNumber || 1;

                LV_LoadData_Ajax(function() {
                    if (state.tableScrollPosition) {
                        setTimeout(function() {
                            $('.table-wrapper').scrollTop(state.tableScrollPosition);
                        }, 100);
                    }
                    if (state.pageScrollPosition) {
                        setTimeout(function() {
                            $('html, body').scrollTop(state.pageScrollPosition);
                        }, 150);
                    }
                });
            } else {
                LV_LoadData_Ajax();
            }
        }

        function clearPageState() {
            sessionStorage.removeItem('part6QuestionListState');
        }

        function LV_LoadData_Ajax(callback) {
            $("#LV_Waiting").css("display", "");
            var zSearch = $("#txtSearch").val();
            var zFromDate = $('#txtFromDate').val();
            var zToDate = $('#txtToDate').val();
            var zLevel = $('#txtLevel').val();
            var zStatusFilter = $('#statusFilter').val();
            if (zLevel.length == 0)
                zLevel = 0;

            var zDataRequest = {
                "Search": zSearch,
                "Level": zLevel,
                "fromDate": zFromDate,
                "toDate": zToDate,
                "pageSize": _PageSize,
                "pageNumber": _PageNumber,
                "StatusFilter": zStatusFilter
            };

            $.ajax({
                type: 'POST',
                url: "/TOEICPart6/QuestionList?handler=LoadData",
                data: JSON.stringify(zDataRequest),
                contentType: "application/json",
                dataType: "json",
            })
            .done(function (dataResponse) {
                _DataView = dataResponse.data || dataResponse;
                _TotalItems = dataResponse.totalCount || _DataView.length;

                LV_DisplayData();
                renderPagination();

                $("#LV_Waiting").css("display", "none");
                $("#Info_View").html("<i class='fas fa-info-circle me-2'></i>Total: " + _TotalItems + " passages");

                if (typeof callback === 'function') {
                    callback();
                }
            })
            .fail(function (error) {
                showAlertModal('Error: ' + error.responseText, 'error');
                $("#LV_Waiting").css("display", "none");
            });
        }

        function LV_DisplayData() {
            var zContent = "";
            var n = _DataView ? _DataView.length : 0;
            var zNo = 1 + (_PageNumber - 1) * _PageSize;

            for (i = 0; i < n; i++) {
                var isPublished = _DataView[i].Publish && _DataView[i].RecordStatus !== 99;
                var fullText = _DataView[i].QuestionText || '';
                var escapedText = $('<div>').text(fullText).html();

                zContent += `<tr>`;
                zContent += `<td><div><strong>${zNo}</strong></div></td>`;

                zContent += `<td>`;
                zContent += `  <div class="text-cell-wrapper" data-question-key="${_DataView[i].QuestionKey}">`;
                zContent += `    <div class="text-visible" data-full-text="${escapedText}">${fullText}</div>`;
                zContent += `    <div class="text-full">${fullText}</div>`;
                zContent += `  </div>`;
                zContent += `</td>`;

                zContent += `<td><div>${_DataView[i].SkillLevel}</div></td>`;
                zContent += `<td><div>${_DataView[i].AmountAccess}</div></td>`;
                zContent += `<td><div><button type='button' class='btn btn-questionsublist' onclick='btnQuestionSubList_Click("${_DataView[i].QuestionKey}")'>View</button></div></td>`;
                zContent += `<td><div><button class='btn-toggle-publish ${isPublished ? "btn-on" : "btn-off"}' onclick='togglePublish(this, "${_DataView[i].QuestionKey}")'>${isPublished ? "ON" : "OFF"}</button></div></td>`;
                zContent += "</tr>";
                zNo++;
            }

            $("#LV_DataBody").html(zContent);
            setupTextCellEvents();
        }

        function setupTextCellEvents() {
            let hoverTimeout;
            let isTooltipVisible = false;

            $('.text-visible').each(function() {
                const $element = $(this);
                const fullText = $element.data('full-text');
                const questionKey = $element.closest('.text-cell-wrapper').data('question-key');

                // Mouseenter - Start timer
                $element.on('mouseenter', function(e) {
                    const targetElement = this;

                    hoverTimeout = setTimeout(function() {
                        if (!isTooltipVisible) {
                            showCenteredTooltip(targetElement, fullText);
                            isTooltipVisible = true;
                        }
                    }, 1000);
                });

                // Mouseleave - Cancel timer if not yet shown
                $element.on('mouseleave', function(e) {
                    clearTimeout(hoverTimeout);

                    // Check if mouse moved to tooltip
                    setTimeout(function() {
                        if (!$('.custom-tooltip-centered:hover').length && !$('#tooltipBackdrop:hover').length) {
                            hideAllTooltips();
                            isTooltipVisible = false;
                        }
                    }, 100);
                });

                // Click - Navigate
                $element.on('click', function(e) {
                    if (!isTooltipVisible) {
                        EditRecord(questionKey);
                    }
                });
            });

            // Keep tooltip open when hovering over it
            $(document).on('mouseenter', '.custom-tooltip-centered', function() {
                isTooltipVisible = true;
            });

            $(document).on('mouseleave', '.custom-tooltip-centered', function(e) {
                // Check if mouse is still over text element
                setTimeout(function() {
                    if (!$('.text-visible:hover').length) {
                        hideAllTooltips();
                        isTooltipVisible = false;
                    }
                }, 100);
            });
        }

        function showCenteredTooltip(element, text) {
            // Remove existing tooltip
            $('.custom-tooltip-centered').remove();

            // Create tooltip
            const tooltip = $(`
                <div class="custom-tooltip-centered">
                    <div class="tooltip-inner">${text}</div>
                </div>
            `);

            // Append to body
            $('body').append(tooltip);

            // Show backdrop
            $('#tooltipBackdrop').addClass('show');

            // Prevent click propagation
            tooltip.on('click', function(e) {
                e.stopPropagation();
            });

            // Allow scrolling
            tooltip.on('wheel', function(e) {
                e.stopPropagation();
            });

            // Store reference
            _CurrentTooltip = tooltip;
        }

        function hideAllTooltips() {
            $('.custom-tooltip-centered').remove();
            $('#tooltipBackdrop').removeClass('show');
            _CurrentTooltip = null;
        }

        function renderPagination() {
            const totalPages = Math.ceil(_TotalItems / _PageSize);
            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) return;

            pagination.append(`
                <li class="page-item ${_PageNumber === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${_PageNumber - 1}); return false;" aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `);

            let startPage = Math.max(1, _PageNumber - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                pagination.append(`
                    <li class="page-item ${i === _PageNumber ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `);
            }

            pagination.append(`
                <li class="page-item ${_PageNumber === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${_PageNumber + 1}); return false;" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(_TotalItems / _PageSize);
            if (page >= 1 && page <= totalPages) {
                hideAllTooltips();
                _PageNumber = page;
                LV_LoadData_Ajax();
                $('.table-wrapper').scrollTop(0);
            }
        }

        function EditRecord(QuestionKey) {
            savePageState();
            window.location = "/TOEICPart6/Question?Key=" + QuestionKey + "&source=QuestionList";
        }

        function btnQuestionSubList_Click(QuestionKey) {
            savePageState();
            window.location = "/TOEICPart6/QuestionSubList?QuestionKey=" + QuestionKey;
        }

             function togglePublish(button, questionKey) {
            const isOn = $(button).hasClass('btn-on');
            const newState = !isOn;
            const confirmMessage = newState
                ? "Do you want to turn ON this passage?"
                : "Do you want to turn OFF this passage?";

            showConfirmModal(
                confirmMessage,
                function() {
                    $.ajax({
                        type: 'POST',
                        url: '/TOEICPart6/QuestionList?handler=TogglePublish',
                        data: JSON.stringify({ questionKey: questionKey, publish: newState }),
                        contentType: 'application/json',
                        dataType: 'json'
                    }).done(data => {
                        if (data.status === 'OK') {
                            if (newState) {
                                $(button).removeClass('btn-off').addClass('btn-on').text('ON');
                                showAlertModal("Passage turned ON successfully!", "success");
                            } else {
                                $(button).removeClass('btn-on').addClass('btn-off').text('OFF');
                                showAlertModal("Passage turned OFF successfully!", "success");
                            }
                        } else if (data.status === 'VALIDATION_ERROR') {
                            // Display detailed validation errors
                            let errorMessage = data.message + "\n\n";
                            if (data.errors && data.errors.length > 0) {
                                errorMessage += data.errors.map((err, idx) => `${idx + 1}. ${err}`).join('\n');
                            }
                            showAlertModal(errorMessage, "warning", "Validation Failed");
                        } else {
                            showAlertModal("Error: " + data.message, "error");
                        }
                    }).fail(error => {
                        showAlertModal("Error: " + error.responseText, "error");
                    });
                },
                'Change Status'
            );
        }
        function showConfirmModal(message, onConfirm, title = 'Confirm Action') {
            $('#confirmModalLabel').html(`<i class="fas fa-exclamation-triangle me-2"></i>${title}`);
            $('#confirmModalBody').text(message);

            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            $('#confirmModalBtn').off('click');
            $('#confirmModalBtn').on('click', function() {
                confirmModal.hide();
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });

            confirmModal.show();
        }

        function showAlertModal(message, type = 'success', title = null) {
            const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            const header = $('#alertModalHeader');
            const titleElement = $('#alertModalLabel');

            header.removeClass('bg-success bg-danger bg-warning text-white');

            let icon = 'fa-info-circle';
            let defaultTitle = 'Notification';
            let headerClass = 'bg-primary text-white';

            if (type === 'success') {
                icon = 'fa-check-circle';
                defaultTitle = 'Success';
                headerClass = 'bg-success text-white';
            } else if (type === 'error' || type === 'danger') {
                icon = 'fa-times-circle';
                defaultTitle = 'Error';
                headerClass = 'bg-danger text-white';
            } else if (type === 'warning') {
                icon = 'fa-exclamation-triangle';
                defaultTitle = 'Warning';
                headerClass = 'bg-warning text-white';
            }

            header.addClass(headerClass);
            titleElement.html(`<i class="fas ${icon} me-2"></i>${title || defaultTitle}`);

            // Convert line breaks to <br> and format list
            const formattedMessage = message
                .replace(/\n/g, '<br>')
                .replace(/(\d+\.\s)/g, '<strong>$1</strong>');

            $('#alertModalBody').html(`<div style="text-align: left; line-height: 1.6;">${formattedMessage}</div>`);

            alertModal.show();
        }
    </script>
}